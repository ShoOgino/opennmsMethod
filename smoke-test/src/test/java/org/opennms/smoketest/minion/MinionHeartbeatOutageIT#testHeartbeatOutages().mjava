    @Test
    public void testHeartbeatOutages() throws Exception {
        Date startOfTest = new Date();

        // Wait for the Minion to show up
        await().atMost(90, SECONDS).pollInterval(5, SECONDS)
            .until(DaoUtils.countMatchingCallable(
                 stack.postgres().dao(MinionDaoHibernate.class),
                 new CriteriaBuilder(OnmsMinion.class)
                     .gt("lastUpdated", startOfTest)
                     .eq("location", stack.minion().getLocation())
                     .toCriteria()
                 ),
                 is(1)
             );

        // Make sure that the node is available
        await().atMost(180, SECONDS).pollInterval(5, SECONDS)
            .until(DaoUtils.countMatchingCallable(
                stack.postgres().dao(NodeDaoHibernate.class),
                new CriteriaBuilder(OnmsNode.class)
                .eq("foreignSource", "Minions")
                .eq("foreignId", stack.minion().getId())
                .toCriteria()
                ),
            equalTo(1)
        );

        // Make sure that the expected events are present

        /*
        assertEquals(1, DaoUtils.countMatchingCallable(
            stack.postgres().dao(.getDao(EventDaoHibernate.class),
            new CriteriaBuilder(OnmsEvent.class)
            .eq("eventUei", EventConstants.MONITORING_SYSTEM_ADDED_UEI)
            .like("eventParms", String.format("%%%s=%s%%", EventConstants.PARAM_MONITORING_SYSTEM_TYPE, OnmsMonitoringSystem.TYPE_MINION))
            .like("eventParms", String.format("%%%s=%s%%", EventConstants.PARAM_MONITORING_SYSTEM_ID, "00000000-0000-0000-0000-000000ddba11"))
            .like("eventParms", String.format("%%%s=%s%%", EventConstants.PARAM_MONITORING_SYSTEM_LOCATION, "MINION"))
            .toCriteria()
            ).call().intValue()
        );
        */

        assertEquals(1,
            stack.postgres().dao(EventDaoHibernate.class).findMatching(
                new CriteriaBuilder(OnmsEvent.class)
                    .alias("eventParameters", "eventParameters")
                    .eq("eventUei", EventConstants.MONITORING_SYSTEM_ADDED_UEI).toCriteria()).stream()
                    .filter(e -> e.getEventParameters().stream()
                            .anyMatch(p -> EventConstants.PARAM_MONITORING_SYSTEM_TYPE.equals(p.getName()) && OnmsMonitoringSystem.TYPE_MINION.equals(p.getValue())))
                    .filter(e -> e.getEventParameters().stream()
                            .anyMatch(p -> EventConstants.PARAM_MONITORING_SYSTEM_ID.equals(p.getName()) && stack.minion().getId().equals(p.getValue())))
                    .filter(e -> e.getEventParameters().stream()
                            .anyMatch(p -> EventConstants.PARAM_MONITORING_SYSTEM_LOCATION.equals(p.getName()) && stack.minion().getLocation().equals(p.getValue())))
                    .distinct()
                    .count()
        );

        assertEquals(0, DaoUtils.countMatchingCallable(
            stack.postgres().dao(EventDaoHibernate.class),
            new CriteriaBuilder(OnmsEvent.class)
            .eq("eventUei", EventConstants.MONITORING_SYSTEM_LOCATION_CHANGED_UEI)
            .toCriteria()
            ).call().intValue()
        );

        for (int i = 0; i < 3; i++) {
            TestContainerUtils.restartContainer(stack.minion());

            // Reset the startOfTest timestamp
            startOfTest = new Date();

            await().atMost(2, MINUTES).pollInterval(5, SECONDS)
                .until(DaoUtils.countMatchingCallable(
                     stack.postgres().dao(MinionDaoHibernate.class),
                     new CriteriaBuilder(OnmsMinion.class)
                         .gt("lastUpdated", startOfTest)
                         .eq("location", stack.minion().getLocation())
                         .toCriteria()
                     ),
                     is(1)
                 );
        }

        for (int i = 0; i < 2; i++) {
            TestContainerUtils.restartContainer(stack.opennms());

            // Reset the startOfTest timestamp
            startOfTest = new Date();

            await().atMost(5, MINUTES).pollInterval(5, SECONDS)
                .until(DaoUtils.countMatchingCallable(
                     stack.postgres().dao(MinionDaoHibernate.class),
                     new CriteriaBuilder(OnmsMinion.class)
                         .gt("lastUpdated", startOfTest)
                         .eq("location", stack.minion().getLocation())
                         .toCriteria()
                     ),
                     is(1)
                 );
        }

        for (int i = 0; i < 1; i++) {
            TestContainerUtils.restartContainer(stack.minion());

            // Reset the startOfTest timestamp
            startOfTest = new Date();

            await().atMost(2, MINUTES).pollInterval(5, SECONDS)
                .until(DaoUtils.countMatchingCallable(
                     stack.postgres().dao(MinionDaoHibernate.class),
                     new CriteriaBuilder(OnmsMinion.class)
                         .gt("lastUpdated", startOfTest)
                         .eq("location", stack.minion().getLocation())
                         .toCriteria()
                     ),
                     is(1)
                 );
        }
    }

