    @Test
    public void verifyStatusEnrichmentApplication() {
        final HibernateDaoFactory daoFactory = stack.postgres().getDaoFactory();
        final ApplicationDaoHibernate applicationDao = daoFactory.getDao(ApplicationDaoHibernate.class);
        final MonitoredServiceDao monitoredServiceDao = daoFactory.getDao(MonitoredServiceDaoHibernate.class);
        final PlatformTransactionManager transactionManager = new HibernateTransactionManager(applicationDao.getSessionFactory());
        final TransactionTemplate transactionTemplate = new TransactionTemplate(transactionManager);

        // Clean up
        applicationDao.findAll().forEach(applicationDao::delete);

        // Set up test data
        createRequisition();
        final OnmsApplication tmpApplication = transactionTemplate.execute(transactionStatus -> {
            final OnmsApplication theApplication = new OnmsApplication();
            theApplication.setName("OpenNMS Application");
            OnmsMonitoringLocation location = new OnmsMonitoringLocation();
            location.setLocationName("Default");
            Set<OnmsMonitoringLocation> locations = new HashSet<>();
            locations.add(location);
            theApplication.setPerspectiveLocations(locations);
            monitoredServiceDao.findAllServices().stream()
                    .filter(ms -> ms.getIpAddress().toString().contains("127.0.0.1"))
                    .forEach(service -> service.addApplication(theApplication));
            applicationDao.save(theApplication);
            return theApplication;
        });

        // Force fully initialized to prevent LazyLoad-Exceptions
        final OnmsApplication application = transactionTemplate.execute(status -> {
            final OnmsApplication initializedApplication = applicationDao.get(tmpApplication.getId());
            initializedApplication.getMonitoredServices().stream().forEach(OnmsMonitoredService::getNodeId);
            return initializedApplication;
        });

        final List<OnmsMonitoredService> services = Lists.newArrayList(application.getMonitoredServices());
        final int nodeId1 = services.get(0).getNodeId();
        final int nodeId2 = services.get(1).getNodeId();

        // Make sure all former outages have been resolved (can be a problem when test is run twice)
        restClient.sendEvent( new EventBuilder(EventConstants.PERSPECTIVE_NODE_REGAINED_SERVICE_UEI, getClass().getSimpleName())
                .setNodeid(nodeId1)
                .setInterface(InetAddressUtils.getInetAddress("127.0.0.1"))
                .setService("ICMP")
                .setParam("perspective", "Default")
                .getEvent());
        restClient.sendEvent( new EventBuilder(EventConstants.PERSPECTIVE_NODE_REGAINED_SERVICE_UEI, getClass().getSimpleName())
                .setNodeid(nodeId2)
                .setInterface(InetAddressUtils.getInetAddress("127.0.0.1"))
                .setService("ICMP")
                .setParam("perspective", "Default")
                .setSeverity(OnmsSeverity.CRITICAL.getLabel())
                .getEvent());

        // Force application provider to reload (otherwise we have to wait until cache is invalidated)
        karafShell.runCommand("opennms:graph-force-reload --container application");

        // Fetch data nothing down
        final JSONObject query = new JSONObject()
                .put("semanticZoomLevel", 1)
                .put("verticesInFocus", Lists.newArrayList(String.format("Application:%s", application.getId())));
        given().log().ifValidationFails()
                .body(query.toString())
                .contentType(ContentType.JSON)
                .post("{container_id}/{namespace}", "application", "application")
                .then()
                .log().ifValidationFails()
                .statusCode(200)
                .contentType(ContentType.JSON)
                .content("vertices", Matchers.hasSize(3))
                .content("vertices[0].status.severity", Matchers.is("Normal"))
                .content("vertices[1].status.severity", Matchers.is("Normal"))
                .content("vertices[2].status.severity", Matchers.is("Normal"))
                .content("vertices[0].status.count", Matchers.is(0))
                .content("vertices[1].status.count", Matchers.is(0))
                .content("vertices[2].status.count", Matchers.is(0));

        // Prepare simulated outages
        final Event nodeLostServiceEvent = new EventBuilder(EventConstants.PERSPECTIVE_NODE_LOST_SERVICE_UEI, getClass().getSimpleName())
                .setNodeid(nodeId1)
                .setInterface(InetAddressUtils.getInetAddress("127.0.0.1"))
                .setService("ICMP")
                .setParam("perspective", "Default")
                .getEvent();
        final Event nodeLostServiceEventApp2 = new EventBuilder(EventConstants.PERSPECTIVE_NODE_LOST_SERVICE_UEI, getClass().getSimpleName())
                .setNodeid(nodeId2)
                .setInterface(InetAddressUtils.getInetAddress("127.0.0.1"))
                .setService("ICMP")
                .setParam("perspective", "Default")
                .setSeverity(OnmsSeverity.CRITICAL.getLabel())
                .getEvent();

        // Take service down, reload graph and verify
        restClient.sendEvent(nodeLostServiceEvent);
        karafShell.runCommand("opennms:graph-force-reload --container application");
        final Response response = given().log().ifValidationFails()
                .body(query.toString())
                .contentType(ContentType.JSON)
                .post("{container_id}/{namespace}", "application", "application")
                .then()
                .log().ifValidationFails()
                .statusCode(200)
                .contentType(ContentType.JSON)
                .extract().response();
        final ApplicationViewResponse applicationViewResponse = new ApplicationViewResponse(response);
        assertThat(applicationViewResponse.length(), Matchers.is(3));
        verifyStatus(applicationViewResponse.getVertexByApplicationId(application.getId()), "Minor", 1);
        verifyStatus(applicationViewResponse.getVertexByNodeId(nodeId1), "Minor", 1);
        verifyStatus(applicationViewResponse.getVertexByNodeId(nodeId2), "Normal", 0);

        // Take service down with severity higher than Major
        restClient.sendEvent(nodeLostServiceEventApp2);
        karafShell.runCommand("opennms:graph-force-reload --container application");
        final Response response2 = given().log().ifValidationFails()
                .body(query.toString())
                .contentType(ContentType.JSON)
                .post("{container_id}/{namespace}", "application", "application")
                .then()
                .log().ifValidationFails()
                .statusCode(200)
                .contentType(ContentType.JSON)
                .extract().response();
        final ApplicationViewResponse applicationViewResponse2 = new ApplicationViewResponse(response2);
        assertThat(applicationViewResponse2.length(), Matchers.is(3));
        verifyStatus(applicationViewResponse2.getVertexByApplicationId(application.getId()), "Critical", 2);
        verifyStatus(applicationViewResponse2.getVertexByNodeId(nodeId1), "Minor", 1);
        verifyStatus(applicationViewResponse2.getVertexByNodeId(nodeId2), "Critical", 1); // we expect the same severity as the interface with the highest severity

        // Finally clean up
        applicationDao.delete(application);
    }

