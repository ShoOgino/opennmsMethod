    public void save(final OnmsUser onmsUser) throws Exception {
        update();

        m_writeLock.lock();
        
        try {
            User xmlUser = _getUser(onmsUser.getUsername());
            if (xmlUser == null) {
                xmlUser = new User();
                xmlUser.setUserId(onmsUser.getUsername());
            }
            xmlUser.setFullName(onmsUser.getFullName());
            xmlUser.setUserComments(onmsUser.getComments());

            // Contact info
            _setContact(xmlUser, ContactType.email, onmsUser.getEmail());
            
            final Password pass = new Password();
            pass.setEncryptedPassword(onmsUser.getPassword());
            pass.setSalt(onmsUser.getPasswordSalted());
            xmlUser.setPassword(pass);
    
            if (onmsUser.getDutySchedule() != null) {
                xmlUser.setDutySchedules(new ArrayList<String>(onmsUser.getDutySchedule()));
            }
            if (onmsUser.getRoles() != null) {
                xmlUser.setRoles(new ArrayList<String>(onmsUser.getRoles()));
            }
            _writeUser(onmsUser.getUsername(), xmlUser);
        } finally {
            m_writeLock.unlock();
        }
    }

