    @Test
    public void testPollerConfigReloadFail() throws Exception {
        final File temporaryFile = File.createTempFile("poller-configuration-", ".xml", new File(PollerConfigReloadIT.class.getResource("/etc").getFile()));
        PollerConfigFactory.setPollerConfigFile(temporaryFile);

        final AtomicBoolean invalid = new AtomicBoolean(false);
        FilterDao filterDao = mock(FilterDao.class);
        doAnswer(invocation -> {
            if (invalid.get()) {
                throw new FilterParseException("Something fishy");
            }
            return null;
        }).when(filterDao).validateRule(any(String.class));
        FilterDaoFactory.setInstance(filterDao);

        IOUtils.copy(new FileInputStream(PollerConfigReloadIT.class.getResource("/poller-configuration-valid1.xml").getFile()), new FileOutputStream(temporaryFile));
        long lastModified = temporaryFile.lastModified();

        PollerConfigFactory.init();

        assertEquals("IPADDR IPLIKE 1.*.*.*", PollerConfigFactory.getInstance().getPackage("example1").getFilter().getContent());

        IOUtils.copy(new FileInputStream(PollerConfigReloadIT.class.getResource("/poller-configuration-valid2.xml").getFile()), new FileOutputStream(temporaryFile));
        temporaryFile.setLastModified(lastModified + 1000);

        invalid.set(true);
        try {
            PollerConfigFactory.getInstance().update();
        } catch (FilterParseException e) {
            // we expect this
        }

        assertEquals("IPADDR IPLIKE 1.*.*.*", PollerConfigFactory.getInstance().getPackage("example1").getFilter().getContent());

        IOUtils.copy(new FileInputStream(PollerConfigReloadIT.class.getResource("/poller-configuration-valid2.xml").getFile()), new FileOutputStream(temporaryFile));
        temporaryFile.setLastModified(lastModified + 2000);

        invalid.set(false);
        PollerConfigFactory.getInstance().update();

        assertEquals("IPADDR IPLIKE 2.*.*.*", PollerConfigFactory.getInstance().getPackage("example1").getFilter().getContent());
    }

