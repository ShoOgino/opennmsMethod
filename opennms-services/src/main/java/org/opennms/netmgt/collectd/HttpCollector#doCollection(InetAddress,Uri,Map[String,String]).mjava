    /**
     * Performs HTTP collection.
     * 
     * Couple of notes to make the implementation of this client library
     * less obtuse:
     * 
     *   - HostConfiguration class is not created here because the library
     *     builds it when a URI is defined.
     *     
     * @param uriDef
     * @param parameters
     * @throws HttpException
     * @throws IOException
     */
    private void doCollection(final InetAddress address, Uri uriDef, Map<String, String> parameters) throws HttpCollectorException {

        HttpClient client = null;
        HttpMethod method = null;
        
        try {
            client = new HttpClient(buildParams(uriDef, parameters));
            method = buildHttpMethod(address, uriDef);
            client.executeMethod(method);
            List<HttpCollectionAttribute> butes = processResponse(method.getResponseBodyAsString(), uriDef);
            
            if (butes.isEmpty()) {
                throw new HttpCollectorException("No attributes specified were found: ",client);
            }
            
            // FIXME: get the real collectionName
            RrdRepository rrdRepository = HttpCollectionConfigFactory.getInstance().getRrdRepository("collectionName");
            
            // FIXME: get the real nodeId
            final int nodeId = 1;
            ResourceIdentifier resource = new ResourceIdentifier() {

                public String getOwnerName() {
                    return address.getHostAddress();
                }

                public File getResourceDir(RrdRepository repository) {
                    return new File(repository.getRrdBaseDir(), Integer.toString(nodeId));
                }
                
            };
            
            for (HttpCollectionAttribute attribute : butes) {
                PersistOperationBuilder builder = new PersistOperationBuilder(rrdRepository, resource, attribute.getName());
                builder.declareAttribute(attribute);
                builder.setAttributeValue(attribute, attribute.getValue());
                builder.commit();
            }
            
        } catch (URIException e) {
            throw new HttpCollectorException("Error building HttpClient URI", client);
        } catch (HttpException e) {
            throw new HttpCollectorException("Error building HttpMethod", client);
        } catch (IOException e) {
            throw new HttpCollectorException("IO Error retrieving page", client);
        } catch (RrdException e) {
            throw new HttpCollectorException("Error writing RRD", client);
        } finally {
            method.releaseConnection();
        }
        
    }

