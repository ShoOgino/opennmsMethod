    private static URI buildUri(final HttpCollectionSet collectionSet) throws URISyntaxException {
        HashMap<String,String> substitutions = new HashMap<String,String>();
        substitutions.put("ipaddr", InetAddressUtils.str(collectionSet.getAgent().getAddress()));
        substitutions.put("nodeid", Integer.toString(collectionSet.getAgent().getNodeId()));

        final URIBuilder ub = new URIBuilder();
        ub.setScheme(collectionSet.getUriDef().getUrl().getScheme());
        ub.setHost(substituteKeywords(substitutions, collectionSet.getUriDef().getUrl().getHost(), "getHost"));
        ub.setPort(collectionSet.getPort());
        ub.setPath(substituteKeywords(substitutions, collectionSet.getUriDef().getUrl().getPath(), "getURL"));

        final String query = substituteKeywords(substitutions, collectionSet.getUriDef().getUrl().getQuery().orElse(null), "getQuery");
        final List<NameValuePair> params = URLEncodedUtils.parse(query, StandardCharsets.UTF_8);
        ub.setParameters(params);

        ub.setFragment(substituteKeywords(substitutions, collectionSet.getUriDef().getUrl().getFragment().orElse(null), "getFragment"));
        return ub.build();
    }

