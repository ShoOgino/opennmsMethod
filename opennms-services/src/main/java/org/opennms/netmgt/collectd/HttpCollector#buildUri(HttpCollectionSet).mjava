    private URI buildUri(final HttpCollectionSet collectionSet) throws URIException {
        HashMap<String,String> substitutions = new HashMap<String,String>();
        substitutions.put("ipaddr", collectionSet.getAgent().getInetAddress().getHostAddress());
        substitutions.put("nodeid", Integer.toString(collectionSet.getAgent().getNodeId()));
        
        return new URI(collectionSet.getUriDef().getUrl().getScheme(),
                collectionSet.getUriDef().getUrl().getUserInfo(),
                substituteKeywords(substitutions, collectionSet.getUriDef().getUrl().getHost(), "getHost"),
                collectionSet.getUriDef().getUrl().getPort(),
                substituteKeywords(substitutions, collectionSet.getUriDef().getUrl().getPath(), "getURL"),
                substituteKeywords(substitutions, collectionSet.getUriDef().getUrl().getQuery(), "getQuery"),
                substituteKeywords(substitutions, collectionSet.getUriDef().getUrl().getFragment(), "getFragment"));
    }

