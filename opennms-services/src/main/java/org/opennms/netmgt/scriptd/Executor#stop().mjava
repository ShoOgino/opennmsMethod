    /**
     * Stops a currently running fiber. If the fiber has already been stopped
     * then the command is silently ignored. If the fiber was never started then
     * an exception is generated.
     *
     * @throws java.lang.IllegalStateException
     *             Thrown if the fiber was never started.
     */
    public synchronized void stop() {
        Category log = (Category) m_mgr.lookupBean("log");

        if (m_worker == null) {
            throw new IllegalStateException("The fiber has never been run");
        }

        if (m_status != STOPPED) {
            m_status = STOP_PENDING;
        }

        if (m_worker.isAlive()) {
            m_worker.interrupt();
        }

        StopScript[] stopScripts = m_config.getStopScripts();

        notifyAll();

        for (int i = 0; i < stopScripts.length; i++) {
            try {
                m_mgr.exec(stopScripts[i].getLanguage(), "", 0, 0, stopScripts[i].getContent());
            }

            catch (BSFException ex) {
                log.error("Stop script[" + i + "] failed.", ex);
            }
        }

        log.debug("Stopped");
    }

