    /**
     * Performs threshold checking on an JMX RRD interface directory.
     * 
     * @param directory
     *            RRD repository directory
     * @param nodeId
     *            Node identifier
     * @param primary
     *            Primary JMX interface address
     * @param interval
     *            Configured thresholding interval
     * @param range
     *            Age before which PDP is considered out of date           
     * @param date
     *            Source for timestamp to be used for all generated events
     * @param baseIfThresholdMap
     *            Map of configured interface level ThresholdEntity objects
     *            keyed by datasource name.
     * @param allIfThresholdMap
     *            Map of threshold maps indexed by ifLabel
     * @param events
     *            Castor events object containing any events to be generated as
     *            a result of threshold checking.
     * 
     * @throws IllegalArgumentException
     *             if path parameter is not a directory.
     */
    private void checkIfDir(File directory, Integer nodeId, InetAddress primary, int interval, int range, Date date, Map baseIfThresholdMap, Map allIfThresholdMap, Events events) throws IllegalArgumentException {
        // Sanity Check
        if (directory == null || nodeId == null || primary == null || date == null || baseIfThresholdMap == null || allIfThresholdMap == null || events == null) {
            throw new IllegalArgumentException("Null parameters not permitted.");
        }

        if (log().isDebugEnabled()) {
            log().debug("checkIfDir: threshold checking interface dir: " + directory.getAbsolutePath());
        }

        String ifLabel = directory.getName();
        if (log().isDebugEnabled()) {
            log().debug("checkIfDir: ifLabel=" + ifLabel);
        }

        // This is an interface directory extract the
        // interface label from the full path name of the file
        /*
         * String path = directory.getAbsolutePath(); String path = directory
         * int fileSepIndex = path.lastIndexOf(File.separatorChar); if
         * (fileSepIndex >= 0) ifLabel = path.substring(fileSepIndex+1,
         * path.length()); else ifLabel = path;
         */

        // Attempt to retrieve the threshold map for this interface
        // using the ifLabel for the interface
        Map thresholdMap = (Map) allIfThresholdMap.get(ifLabel);
        if (thresholdMap == null) {
            // Doesn't exist yet, go ahead and create it
            // Must maintain a separate threshold map for
            // each interface.
            thresholdMap = new HashMap();

            // Iterate over base interface threshold map and clone each
            // ThresholdEntity object and add it to the threshold map.
            // for this interface.
            // 
            Iterator iter = baseIfThresholdMap.values().iterator();
            while (iter.hasNext()) {
                ThresholdEntity entity = (ThresholdEntity) iter.next();
                thresholdMap.put(entity.getDatasourceName(), entity.clone());
            }

            // Add the new threshold map for this interface
            // to the all interfaces map.
            allIfThresholdMap.put(ifLabel, thresholdMap);
        }

        // Iterate over directory contents and threshold
        // check any RRD files which represent datasources
        // in the threshold maps.
        File[] files = directory.listFiles(RrdFileConstants.RRD_FILENAME_FILTER);

        if (files == null || files.length == 0) {
            if (log().isDebugEnabled()) {
                log().debug("checkIfDir: no RRD files in dir: " + directory);
            }
            return;
        }

        Map<String, String> ifDataMap = new HashMap<String, String>();
        for (int i = 0; i < files.length; i++) {
            // File name has format: <datsource><extension>
            // Must strip off <extension> portion.
            String filename = files[i].getName();
            String datasource = filename.substring(0, filename.indexOf(RrdUtils.getExtension()));

            // Lookup the ThresholdEntity object corresponding
            // to this datasource.
            if (log().isDebugEnabled()) {
                log().debug("checkIfDir: looking up datasource: " + datasource);
            }
            ThresholdEntity threshold = (ThresholdEntity) thresholdMap.get(datasource);
            if (threshold != null) {
                // Use RRD strategy to "fetch" value of the
                // datasource from the RRD file
                Double dsValue = null;
                try {
                	if (range != 0) {
                		if (log().isDebugEnabled()) {
                            log().debug("checking values within " + range + " mS of last possible PDP");
                        }
                		dsValue = RrdUtils.fetchLastValueInRange(files[i].getAbsolutePath(), interval, range);
                	} else {
                        log().debug("checking value of last possible PDP only");
                		dsValue = RrdUtils.fetchLastValue(files[i].getAbsolutePath(), interval);
                	}
                } catch (NumberFormatException e) {
                    log().warn("Unable to convert retrieved value for datasource '" + datasource + "' to a double, skipping evaluation.");
                } catch (RrdException e) {
                    log().info("An error occurred retriving the last value for datasource '" + datasource + "': " + e, e);
                }

                if (dsValue == null || dsValue.isNaN()) {
                    continue;
                }
                
                List<Event> eventList = threshold.evaluateAndCreateEvents(dsValue, date);
                if (eventList.size() == 0) {
                    // Nothing to do, so continue
                    continue;
                }

                if (ifDataMap.size() == 0 && ifLabel != null) {
                    populateIfDataMap(nodeId, ifLabel, ifDataMap);
                }
                
                completeEventListAndAddToEvents(events, eventList, nodeId, primary, ifDataMap);
            }
        }
    }

