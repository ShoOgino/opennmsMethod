    /**
     * Build a complete message ready for sending.
     * 
     * @param session session to use to create a new MimeMessage
     * @return completed message, ready to be passed to Transport.sendMessage
     * @throws JavaMailerException if any of the underlying operations fail
     */
    private Message buildMessage(Session session) throws JavaMailerException {
        try {
            Message message = new MimeMessage(session);
            
            log().debug("From is: " + getFrom());
            message.setFrom(new InternetAddress(getFrom()));
            
            log().debug("To is: " + getTo());
            message.setRecipients(Message.RecipientType.TO, InternetAddress.parse(getTo(), false));
            
            log().debug("Subject is: " + getSubject());
            message.setSubject(getSubject());
            
            log().debug("Message text is: " + getMessageText());
            if (getFileName() != null) {
                log().debug("fileName is non-null--creating a MIME multipart message with file '" + getFileName() + "' as an attachment.");

                /*
                 * Create a MIME multipart message to hold our message text
                 * and the attachment
                 */
                MimeMultipart mp = new MimeMultipart();
                mp.addBodyPart(createTextPart(getMessageText()));
                mp.addBodyPart(createFileAttachment(new File(getFileName())));
                message.setContent(mp);
            } else {
                message.setText(getMessageText());
            }
            
            message.setHeader("X-Mailer", getMailer());
            message.setSentDate(new Date());
            
            message.saveChanges();
            
            return message;
        } catch (AddressException e) {
            log().error("Java Mailer Addressing exception: " + e, e);
            throw new JavaMailerException("Java Mailer Addressing exception: " + e, e);
        } catch (MessagingException e) {
            log().error("Java Mailer messaging exception: " + e, e);
            throw new JavaMailerException("Java Mailer messaging exception: " + e, e);
        }
    }

