    private Map<Integer, List<OnmsMonitoredService>> getServices(Collection<Integer> nodes, List<String> serviceNames) {
        if (nodes == null || nodes.size() == 0) {
            return Maps.newHashMap();
        }

        final CriteriaBuilder builder = new CriteriaBuilder(OnmsMonitoredService.class)
            .alias("ipInterface", "ipInterface")
            .alias("ipInterface.node", "node")
            .eq("ipInterface.isManaged", "M")
            .in("node.id", nodes);

        if (serviceNames != null && serviceNames.size() > 0) {
            builder.alias("serviceType", "serviceType")
            .in("serviceType.name", serviceNames);
        }

        // Retrieve the services and group them by node id
        return m_monitoredServiceDao.findMatching(builder.toCriteria()).stream()
            .collect(Collectors.groupingBy(OnmsMonitoredService::getNodeId));
    }

