    /*
     * This test uses this files from src/test/resources:
     * - thresd-configuration-bug3554.xml
     * - test-thresholds-bug3554.xml
     * 
     * TODO not sure how to emulate a big installation yet.
     * TODO ThresholdingVisitor.create doesn't look like a complex method that could take too much time
     */
    @Test
    public void testBug3554_withDBFilterDao() throws Exception {
        
        String ipAddress = "10.0.0.1";
        
        MockNetwork network = new MockNetwork();
        network.setCriticalService("ICMP");
        network.addNode(1, "testNode");
        network.addInterface(ipAddress);
        network.setIfAlias("eth0");
        network.addService("ICMP");
        network.addService("SNMP");
        MockDatabase db = new MockDatabase();
        db.populate(network);
        db.update("update snmpinterface set snmpifname=?, snmpifdescr=? where id=?", "eth0", "eth0", 1);
        db.update("update node set nodesysoid=? where nodeid=?", ".1.3.6.1.4.1.9.1.222", 1);
        db.update("insert into categories (categoryid, categoryname) values (?, ?)", 10, "IPRA");
        db.update("insert into categories (categoryid, categoryname) values (?, ?)", 11, "NAS");
        db.update("insert into category_node values (?, ?)", 10, 1);
        db.update("insert into category_node values (?, ?)", 11, 1);
        DataSourceFactory.setInstance(db);
        Vault.setDataSource(db);
        
        initFactories("/threshd-configuration-bug3554.xml","/test-thresholds-bug3554.xml");
        System.setProperty("opennms.home", "src/test/resources");
        FilterDaoFactory.setInstance(null);
        FilterDao filterDao = FilterDaoFactory.getInstance();
        assertNotNull(filterDao);
        
        Map<String,String> params = new HashMap<String,String>();
        params.put("thresholding-enabled", "true");
        ThresholdingVisitor visitor = ThresholdingVisitor.create(1, ipAddress, "SNMP", getRepository(), params, 300000);
        
        assertNotNull(visitor);
        assertEquals(4, visitor.getThresholdGroups().size()); // mib2, cisco, ciscoIPRA, ciscoNAS
    }

