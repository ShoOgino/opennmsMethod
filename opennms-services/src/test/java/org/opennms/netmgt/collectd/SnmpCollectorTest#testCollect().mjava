    public void testCollect() throws Exception {
        String svcName = "SNMP";

        String m_snmpConfig = "<?xml version=\"1.0\"?>\n"
                + "<snmp-config port=\"1691\" retry=\"3\" timeout=\"800\"\n"
                + "               read-community=\"public\"\n"
                + "               version=\"v1\">\n" + "</snmp-config>\n";

        initializeAgent();

        Reader dataCollectionConfig = getDataCollectionConfigReader("/org/opennms/netmgt/config/datacollection-config.xml");
        initialize(new StringReader(m_snmpConfig), dataCollectionConfig);
        dataCollectionConfig.close();

        OnmsNode node = new OnmsNode();
        node.setId(new Integer(1));
        node.setSysObjectId(".1.3.6.1.4.1.1588.2.1.1.1");
        OnmsSnmpInterface snmpIface = new OnmsSnmpInterface("127.0.0.1", 1, node);
        snmpIface.setIfName("localhost");
        snmpIface.setPhysAddr("00:11:22:33:44");
        OnmsIpInterface iface = new OnmsIpInterface("127.0.0.1", node);
        iface.setIsSnmpPrimary(CollectionType.PRIMARY);
        iface.setId(27);

        Collection outageCalendars = new LinkedList();

        Package pkg = new Package();
        Filter filter = new Filter();
        filter.setContent("IPADDR IPLIKE *.*.*.*");
        pkg.setFilter(filter);
        Service service = new Service();
        service.setName(svcName);
        pkg.addService(service);

        CollectdPackage wpkg = new CollectdPackage(pkg, "foo", false);
        CollectionSpecification spec = new CollectionSpecification(wpkg,
                                                                   svcName,
                                                                   outageCalendars,
                                                                   m_snmpCollector);

        CollectionAgent agent = getCollectionAgent(iface);
        

        
        File nodeDir = m_fileAnticipator.expecting(getSnmpRrdDirectory(), "1");
        for (String file : new String[] { "tcpActiveOpens", "tcpAttemptFails", "tcpCurrEstab",
                "tcpEstabResets", "tcpInErrors", "tcpInSegs", "tcpOutRsts", "tcpOutSegs",
                "tcpPassiveOpens", "tcpRetransSegs" }) {
            m_fileAnticipator.expecting(nodeDir, file + RrdUtils.getExtension());
        }
        
        // don't for get to initialize the agent
        spec.initialize(agent);

        // now do the actual collection
        assertEquals("collection status",
                     ServiceCollector.COLLECTION_SUCCEEDED,
                     spec.collect(agent));
        
        
        System.err.println("FIRST COLLECTION FINISHED");
        
        //need a one second time elapse to update the RRD
        Thread.sleep(1000);

        // try collecting again
        assertEquals("collection status",
                ServiceCollector.COLLECTION_SUCCEEDED,
                spec.collect(agent));

        System.err.println("SECOND COLLECTION FINISHED");

        // release the agent
        spec.release(agent);
        
        // Wait for any RRD writes to finish up
        Thread.sleep(1000);
    }

