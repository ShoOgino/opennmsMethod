    @Before
    public void setUp() throws Exception {
        MockLogAppender.setupLogging();
        MockDatabase db = new MockDatabase();

        final TransactionAwareDataSourceProxy proxy = new TransactionAwareDataSourceProxy(db);
		DataSourceFactory.setInstance(proxy);

		PlatformTransactionManager mgr = new DataSourceTransactionManager(proxy);
        
        FilterDao dao = FilterDaoFactory.getInstance();
        if (dao instanceof JdbcFilterDao) {
        	((JdbcFilterDao)dao).setTransactionTemplate(new TransactionTemplate(mgr));
        }

        RrdUtils.setStrategy(m_strategy);
        
        m_provisioner = new OpenNMSProvisioner();
        
        m_eventManager = new MockEventIpcManager();
        m_provisioner.setEventManager(m_eventManager);
        
        m_capsdConfig = new TestCapsdConfigManager(CAPSD_CONFIG);
        CapsdConfigFactory.setInstance(m_capsdConfig);

        m_pollerConfig = new TestPollerConfigManager(POLLER_CONFIG, "localhost", false);
        PollerConfigFactory.setInstance(m_pollerConfig);
        
        m_provisioner.setCapsdConfig(m_capsdConfig);
        m_provisioner.setPollerConfig(m_pollerConfig);

        InputStream configStream = ConfigurationTestUtils.getInputStreamForConfigFile("opennms-server.xml");
        OpennmsServerConfigFactory onmsSvrConfig = new OpennmsServerConfigFactory(configStream);
        configStream.close();
        OpennmsServerConfigFactory.setInstance(onmsSvrConfig);

        configStream = ConfigurationTestUtils.getInputStreamForConfigFile("database-schema.xml");
        DatabaseSchemaConfigFactory.setInstance(new DatabaseSchemaConfigFactory(configStream));
        configStream.close();

        configStream = ConfigurationTestUtils.getInputStreamForResource(this, "/org/opennms/netmgt/capsd/collectd-configuration.xml");
        CollectdConfigFactory.setInstance(new CollectdConfigFactory(configStream, onmsSvrConfig.getServerName(), onmsSvrConfig.verifyServer()));
        configStream.close();

        JdbcTemplate jdbcTemplate = new JdbcTemplate(db);

        m_syncer = new JdbcCapsdDbSyncer();
        m_syncer.setJdbcTemplate(jdbcTemplate);
        m_syncer.setOpennmsServerConfig(OpennmsServerConfigFactory.getInstance());
        m_syncer.setCapsdConfig(m_capsdConfig);
        m_syncer.setPollerConfig(m_pollerConfig);
        m_syncer.setCollectdConfig(CollectdConfigFactory.getInstance());
        m_syncer.setNextSvcIdSql(db.getNextServiceIdStatement());
        m_syncer.afterPropertiesSet();

        m_syncer.syncServices();
        m_provisioner.setCapsdDbSyncer(m_syncer);

    }

