    protected void setUp() throws Exception {
        super.setUp();
        MockLogAppender.setupLogging();
        MockDatabase db = new MockDatabase();
        DataSourceFactory.setInstance(db);
        
        Properties properties = new Properties();
        RrdConfig.setProperties(properties);

        m_strategy = mock(RrdStrategy.class);
        RrdUtils.setStrategy((RrdStrategy)m_strategy.proxy());
        
        m_provisioner = new OpenNMSProvisioner();
        
        m_eventManager = new MockEventIpcManager();
        m_provisioner.setEventManager(m_eventManager);
        
        m_capsdConfig = new TestCapsdConfigManager(CAPSD_CONFIG);
        CapsdConfigFactory.setInstance(m_capsdConfig);

        m_pollerConfig = new TestPollerConfigManager(POLLER_CONFIG, "localhost", false);
        PollerConfigFactory.setInstance(m_pollerConfig);
        
        m_provisioner.setCapsdConfig(m_capsdConfig);
        m_provisioner.setPollerConfig(m_pollerConfig);
        
        OpennmsServerConfigFactory onmsSvrConfig = new OpennmsServerConfigFactory(ConfigurationTestUtils.getReaderForConfigFile("opennms-server.xml"));
        OpennmsServerConfigFactory.setInstance(onmsSvrConfig);
        
        DatabaseSchemaConfigFactory.setInstance(new DatabaseSchemaConfigFactory(ConfigurationTestUtils.getReaderForConfigFile("database-schema.xml")));
        CollectdConfigFactory.setInstance(new CollectdConfigFactory(ConfigurationTestUtils.getReaderForResource(this, "/org/opennms/netmgt/capsd/collectd-configuration.xml"), onmsSvrConfig.getServerName(), onmsSvrConfig.verifyServer()));

        m_syncer = new JdbcCapsdDbSyncer();
        m_syncer.setOpennmsServerConfig(OpennmsServerConfigFactory.getInstance());
        m_syncer.setCapsdConfig(m_capsdConfig);
        m_syncer.setPollerConfig(m_pollerConfig);
        m_syncer.setCollectdConfig(CollectdConfigFactory.getInstance());
        m_syncer.setNextSvcIdSql(db.getNextServiceIdStatement());
        m_syncer.afterPropertiesSet();

        Connection conn = db.getConnection();
        try {
            m_syncer.syncServices(conn);
        } finally {
            conn.close();
        }

    }

