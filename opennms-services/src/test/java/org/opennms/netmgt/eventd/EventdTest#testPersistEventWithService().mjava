    /**
     * Test that eventd's service ID lookup works properly.
     */
    @Test(timeout=30000)
    public void testPersistEventWithService() throws Exception {
        CriteriaBuilder cb = new CriteriaBuilder(OnmsEvent.class);
        cb.eq("eventUei", EventConstants.SERVICE_UNRESPONSIVE_EVENT_UEI);
        assertEquals(0, m_eventDao.countMatching(cb.toCriteria()));
        assertNotNull(m_serviceTypeDao.findByName("ICMP"));

        OnmsNode node = m_databasePopulator.getNode1();
        assertNotNull(node);
        OnmsIpInterface intf = node.getIpInterfaceByIpAddress("192.168.1.1");
        assertNotNull(intf);
        System.err.println("services = " + intf.getMonitoredServices());
        OnmsMonitoredService svc = intf.getMonitoredServiceByServiceType("ICMP");
        assertNotNull(svc);
        assertEquals("192.168.1.1", str(svc.getIpAddress()));
        final Integer serviceId = svc.getServiceId();
        sendServiceDownEvent(null, svc);

        while(m_eventDao.countMatching(cb.toCriteria()) != 1) {
            Thread.sleep(SLEEP_TIME);
        }
        assertEquals(1, m_eventDao.countMatching(cb.toCriteria()));
        assertEquals("service ID for event", serviceId, m_eventDao.findMatching(cb.toCriteria()).get(0).getServiceType().getId());
    }

