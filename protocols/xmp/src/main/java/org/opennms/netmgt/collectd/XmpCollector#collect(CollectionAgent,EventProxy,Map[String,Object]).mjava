    /**
     * {@inheritDoc}
     *
     * Collect data, via XMP, from a particular agent EventProxy is
     *       used to send opennms events into the system in case a
     *       collection fails or if a system is back working again after a
     *       failure (suceed event).  But otherwise, no events sent if
     *       collection succeeds.  Collect is called once per agent per
     *       collection cycle.  Parameters are a map of String Key/String
     *       Value passed in.  Keys come from collectd config
     */
    public CollectionSet collect(CollectionAgent agent, EventProxy eproxy, 
            Map<String, Object> parameters)
    {
        XmpCollectionSet collectionSet;
        XmpSession session;
        long oldUptime;
        int i;
        XmpCollection collection;
        XmpCollectionResource scalarResource;

        log().debug("collect agent "+agent);

        oldUptime = 0;
        
        // First go to the peer factory
        XmpAgentConfig peerConfig = XmpPeerFactory.getInstance().getAgentConfig(agent.getInetAddress());
        authenUser = peerConfig.getAuthenUser();
        timeout = (int)peerConfig.getTimeout();
        retries = peerConfig.getRetry();
        xmpPort = peerConfig.getPort();

        if (parameters.get("authenUser") != null)
            authenUser = ParameterMap.getKeyedString(parameters, "authenUser", null);

        if (parameters.get("timeout") != null) {
            timeout = ParameterMap.getKeyedInteger(parameters, "timeout", 3000);
        }
        
        if (parameters.get("retry") != null) {
            retries = ParameterMap.getKeyedInteger(parameters, "retries", 0);
        }
        parameters.get("collection");

        if (parameters.get("port") != null) {
            xmpPort = Integer.valueOf((String)parameters.get("port"));
        }

        //log().debug("collect got parameters for "+agent);

        String collectionName = ParameterMap.getKeyedString(parameters, "collection", null);

        //log().debug("XMP collection name "+collectionName);

        // collectionName tells us what set of data to get 
        // this would/will come from xmp-datacollection.xml
        if (collectionName == null) {
            // log this!
            log().warn("collect found no collectionName for "+agent);
            return null;
        }

        //log().debug("collect got collectionName for "+agent);
        log().debug("XmpCollector: collect "+collectionName+" from "+agent);

        // get/create our collections set
        collectionSet = new XmpCollectionSet(agent);
        collectionSet.setCollectionTimestamp(new Date());
        collectionSet.setStatusFailed(); // default
        collectionSet.ignorePersistTrue(); // default not to persist

        // default collection resource for putting scalars in
        scalarResource = new XmpCollectionResource(agent,null,"node",null);
        collectionSet.addResource(scalarResource);

        // get the collection, again, from the data config file factory
        // because it could have changed; its not necessarily re-parsed,
        // but we are getting another copy of it for each agent
        // that we are queried each time we are invoked

        collection = XmpCollectionFactory.getInstance().getXmpCollection(collectionName);
        if (collection == null) {
            log().warn("collect found no matching collection for "+agent);
            return collectionSet;
        }

        oldUptime = agent.getSavedSysUpTime();

        // open/get a session with the target agent

        log().debug("collect: attempting to open XMP session with "+agent.getInetAddress()+":"+xmpPort+","+authenUser);

        // Set the SO_TIMEOUT, why don't we...
        sockopts.setConnectTimeout(timeout);

        session = new XmpSession(sockopts,
                                 agent.getInetAddress(),
                                 xmpPort,authenUser);

        if (session == null) {
            // send event saying collection failed
            log().warn("collect unable to get XMP session with "+agent);
            return collectionSet;
        }

        if (session.isClosed()) {
            log().warn("collect unable to open XMP session with "+agent);
            return collectionSet;
        }

        log().debug("collect: successfully opened XMP session with"+agent);

        // for each group within the collection (from data config)
        // query agent

        for (Group group : collection.getGroups().getGroup()) {

            // get name of group and MIB objects in group
            String groupName = group.getName();
            MibObj[] mibObjects = group.getMibObj();
            XmpVar[] vars = new XmpVar[mibObjects.length];

            log().debug("collecting XMP group "+groupName+" with "+mibObjects.length+" mib objects");

            // prepare the query vars
            for (i=0 ; i< mibObjects.length; i++) {

                vars[i] = new XmpVar(mibObjects[i].getMib(),
                                     mibObjects[i].getVar(), 
                                     mibObjects[i].getInstance(),
                                     "",
                                     Xmp.SYNTAX_NULLSYNTAX);

            } /* for each MIB object in a particular group */

            if ((mibObjects[0].getTable() != null) && 
                    (mibObjects[0].getTable().length() != 0)) {

                String[] tableInfo = new String[3];
                tableInfo[0] = mibObjects[0].getMib();
                tableInfo[1] = mibObjects[0].getTable();
                tableInfo[2] = mibObjects[0].getInstance();

                // tabular query               
                if (handleTableQuery(group.getName(),
                                     group.getResourceType(),
                                     collectionSet,
                                     tableInfo,
                                     session,
                                     vars) == false) {
                    session.closeSession();
                    return collectionSet;
                }
            }
            else {
                // scalar query
                if (handleScalarQuery(group.getName(),
                                      collectionSet,
                                      oldUptime,
                                      session,
                                      scalarResource,
                                      vars) == false) {
                    session.closeSession();
                    return collectionSet;
                }
            }

        } /* for each Group in collection Group list */

        // done talking to this agent; close session
        session.closeSession();

        // Did agent restart since last query?  If so, set
        // ignorePersist to true; our scalar
        // query will have handled this by searching returned
        // MIB objects for sysUpTime

        // WARNING, EACH COLLECTION SHOULD HAVE A SCALAR QUERY THAT
        // INCLUDES Core.sysUpTime 

        collectionSet.setStatus(ServiceCollector.COLLECTION_SUCCEEDED);

        log().debug("XMP collect finished for "+collectionName+", uptime for "+agent+" is "+agent.getSavedSysUpTime());

        return collectionSet;
    }

