    /**
     * Gets the XML document.
     *
     * @param agent the agent
     * @param source the source
     * @return the XML document
     */
    public Document getXmlDocument(CollectionAgent agent, XmlSource source) {
        String urlStr = source.getUrl().replace("{ipaddr}", agent.getHostAddress());
        try {
            URL url = SftpUrlFactory.getUrl(urlStr);
            URLConnection c = url.openConnection();
            c.connect();
            InputStream is = c.getInputStream();
            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
            factory.setIgnoringComments(true);
            DocumentBuilder builder = factory.newDocumentBuilder();
            Document doc = builder.parse(is);
            if (c instanceof SftpUrlConnection) // We need to be sure to close the connections for SFTP
                ((SftpUrlConnection)c).disconnect();
            return doc;
        } catch (Exception e) {
            throw new XmlCollectorException("Can't retrieve data from " + urlStr);
        }
    }

