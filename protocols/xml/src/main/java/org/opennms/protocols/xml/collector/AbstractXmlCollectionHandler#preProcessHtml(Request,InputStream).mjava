    /**
     * Pre-process HTML.
     *
     * @param request the request
     * @param is the input stream
     * @return the updated input stream
     * @throws IOException Signals that an I/O exception has occurred.
     */
    private InputStream preProcessHtml(Request request, InputStream is) throws IOException {
        if (request == null)
            return is;
        if (Boolean.parseBoolean(request.getParameter("pre-parse-html"))) {
            org.jsoup.nodes.Document doc = Jsoup.parse(is, "UTF-8", "/");
            IOUtils.closeQuietly(is);
            return new ByteArrayInputStream(doc.outerHtml().getBytes());
        }
        return is;
    }

