    @Test
    public void testUnmarshalling() {
        // Be conservative about what we ship, so don't be lenient
        if (this.lenient == false) {
            LocalConfiguration.getInstance().getProperties().remove(CASTOR_LENIENT_SEQUENCE_ORDERING_PROPERTY);
        }

        final Resource resource = this.createResource();

        // Assert that resource is valied
        assertNotNull("Resource must not be null", resource);

        // Unmarshall the config file
        Object result = null;
        try {
            switch (impl) {
            case CASTOR:
                result = CastorUtils.unmarshal(this.clazz, resource);
                break;

            case JAXB:
                result = JaxbUtils.unmarshal(this.clazz, resource);
                break;

            default:
                fail("Implementation unknown: " + this.impl);
            }

            // Assert that unmarshalling returned a valid result
            assertNotNull("Unmarshalled instance must not be null", result);

        } catch(AssertionFailedError ex) {
            throw ex;

        } catch(Exception ex) {
            // If we have an expected exception, the returned exception muss
            // match - if not the test failed
            if (this.exception != null) {
                assertEquals(this.exception, exception.toString());

            } else {
                fail("Unexpected exception: " + ex);
            }
        }
    }

