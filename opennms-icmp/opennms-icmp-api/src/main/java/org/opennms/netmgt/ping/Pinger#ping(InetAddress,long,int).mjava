    /**
     * This method is used to ping a remote host to test for ICMP support. If
     * the remote host responds within the specified period, defined by retries
     * and timeouts, then the response time is returned.
     * 
     * @param host
     *            The address to poll.
     * @param timeout
     *            The time to wait between each retry.
     * @param retries
     *            The number of times to retry
     * 
     * @return The response time in microseconds if the host is reachable and has responded with an echo reply, otherwise a null value.
     */
    public Long ping(InetAddress host, long timeout, int retries) throws IOException {
        Category log = ThreadCategory.getInstance(this.getClass());
        
        Long tidKey = getTidKey();

        short sid = sequenceId++;
    	DatagramPacket pkt = getDatagram(host, tidKey, sid);
        PingRequest reply = new PingRequest(host, sid);
        
        waiting.put(tidKey, reply);
        for (int attempts = 0; attempts <= retries && !reply.isSignaled(); ++attempts) {
            synchronized (reply) {
                sendPacket(pkt);
                try {
                    reply.wait(timeout);
                } catch (InterruptedException ex) {
                    // interrupted so return, reset interrupt.
                    Thread.currentThread().interrupt();
                }
            }
        }
        waiting.remove(tidKey);
        
        Long rtt = getRTT(reply);
        log.debug("Ping round trip time for " + host + ": " + rtt + "us");
        return rtt;
    }

