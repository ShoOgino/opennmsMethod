	public void run() {
		input = "";

		InputStreamReader isr = null;
		BufferedReader in = null;
		
		try {
			// Get input from the client
			isr = new InputStreamReader(server.getInputStream());
			in = new BufferedReader(isr);

			readingFromClient: while ((line = in.readLine()) != null) {
				input = input + "\n" + line;
				LogUtils.debugf(this, "Client wrote: %s from %s", line, server.getInetAddress());

				if (status == STARTING_SESSION_STATUS) {
					if (line.equalsIgnoreCase(START_AUTHENTICATION_REQUEST)) {
						if (getSharedASCIIString() != null) {
							LogUtils.debugf(this, "Starting authentication, sending %s to the client", AUTH_REQUIRED_ACK);
							streamToClient.println(AUTH_REQUIRED_ACK);
							status = AUTHENTICATING_STATUS;
						} else {
							LogUtils.debugf(this, "Starting authentication, sending %s to the client", AUTH_NOT_REQUIRED_ACK);
							streamToClient.println(AUTH_NOT_REQUIRED_ACK);
							status = AUTHENTICATED_STATUS;
						}
						continue readingFromClient;
					} else {
						// security reset (a malicious user may use DOS attack before authentication)
						LogUtils.warnf(this, "Wrong client request");
						break readingFromClient;
					}
				}

				if (status == AUTHENTICATING_STATUS) {
					if (getSharedASCIIString() != null) {
						// authentication required (security check)
						if (line.equals(getSharedASCIIString())) {
							status = AUTHENTICATED_STATUS;
							LogUtils.debugf(this, "Authentication success!");
							streamToClient.println(AUTHENTICATION_SUCCESS);
							continue readingFromClient;
						} else {
							streamToClient.println(RESET_SIGNAL);
							LogUtils.warnf(this, "Authentication failure! Resetting session.");
							break readingFromClient;
						}
					}
				}

				if (status == AUTHENTICATED_STATUS || status == DATAFLOW_STATUS) {
					if (line.equalsIgnoreCase(LIST_CURRENT_ALARM_REQUEST)) {
				        LogUtils.debugf(this, "Fetching Events from Database");
					    getEventsByCriteria();
						status = DATAFLOW_STATUS;
						synchronized (streamToClient) {
							 streamToClient.println(ACTIVE_ALARM_BEGIN);
	                         final StringWriter sw = getOutput();
  		                     if (sw != null) {
   		                        final String output = sw.toString();
								LogUtils.infof(this, "String Writer: %s", output); 
		                        streamToClient.print(output);
		                     } else {
		                        LogUtils.errorf(this, "String Writer is null");
		                     }
                             streamToClient.println(ACTIVE_ALARM_END);
                             continue readingFromClient;
							
						}
					} else {
						if (line.equalsIgnoreCase(STOP_ALARM_REQUEST)) {
							LogUtils.debugf(this, "Closing session due client request.");
							break readingFromClient;
						} else {
							LogUtils.warnf(this, "Wrong client request");
							continue readingFromClient;
						}
					}
				}
			}

			LogUtils.debugf(this, "Closing session.  Overall message from %s is: %s", server.getInetAddress(), input);
			server.close();
		} catch (final IOException ioe) {
			LogUtils.warnf(this, ioe, "Error while listening to socket.");
		} finally {
			IOUtils.closeQuietly(in);
			IOUtils.closeQuietly(isr);
		}
	}

