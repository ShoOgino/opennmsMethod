	public void run() {
		input = "";

		try {
			// Get input from the client
			BufferedReader in = new BufferedReader(new InputStreamReader(server
					.getInputStream()));

			readingFromClient: while ((line = in.readLine()) != null) {
				input = input + "\n" + line;
				log.debug("Client wrote: " + line + " from "
						+ server.getInetAddress());

				if (status == STARTING_SESSION_STATUS) {
					if (line.equalsIgnoreCase(START_AUTHENTICATION_REQUEST)) {
						if (sharedAuthAsciiString != null) {
							// authorization required
							streamToClient.println(AUTH_REQUIRED_ACK);
							log.debug("Starting authentication, sending "
									+ AUTH_REQUIRED_ACK + " to the client");
							status = AUTHENTICATING_STATUS;
						} else {
							// authorization not required
							streamToClient.println(AUTH_NOT_REQUIRED_ACK);
							log.debug("Starting authentication, sending "
									+ AUTH_NOT_REQUIRED_ACK + " to the client");
							status = AUTHENTICATED_STATUS;
						}
						continue readingFromClient;
					} else {
						// security reset (a malicious user may use DOS attack
						// before authentication)
						log.warn("Wrong client request");
						break readingFromClient;
					}
				}

				if (status == AUTHENTICATING_STATUS) {
					if (sharedAuthAsciiString != null) {
						// authentication required (security check)
						if (line.equals(sharedAuthAsciiString)) {
							status = AUTHENTICATED_STATUS;
							log.debug("Authentication success!");
							streamToClient.println(AUTHENTICATION_SUCCESS);
							continue readingFromClient;
						} else {
							streamToClient.println(RESET_SIGNAL);
							log
									.warn("Authentication failure! Resetting session.");
							break readingFromClient;
						}
					}
				}

				if (status == AUTHENTICATED_STATUS || status == DATAFLOW_STATUS) {
					if (line.equalsIgnoreCase(LIST_CURRENT_ALARM_REQUEST)) {
						log.debug("Sending alarms to the client");
						refreshAlarms();
						status = DATAFLOW_STATUS;
						synchronized (streamToClient) {
							streamToClient.println(ACTIVE_ALARM_BEGIN);
							List<Event> events = getEvents();
							if (events != null && events.size() > 0) {
                                Iterator<Event> ite = events.iterator();
                                while (ite.hasNext()) {
                                    StringWriter sw = new StringWriter();
                                    Event xmlEvent = ite.next();
                                    try {
                                        log.info("Marshal Event with id: " + xmlEvent.getDbid()); 
                                        xmlEvent.marshal(sw);
                                        log.info("Flushing Event with id: " + xmlEvent.getDbid()); 
                                        sw.flush();
                                        log.info("String Writer:" + sw.getBuffer().toString()); 
                                        if (sw != null) {
                                            streamToClient.print(sw.toString());
                                        } else {
                                            log.warn("String Writer is null");
//                                          break readingFromClient;
                                        }
                                    } catch (MarshalException e) {
                                        log.error("Marshall Exception: " + e);
                                    } catch (ValidationException e) {
                                        log.error("Validation Exception: " + e);
                                    }
                                }
							}
                            streamToClient.println(ACTIVE_ALARM_END);
                            continue readingFromClient;
							
						}
					} else {
						if (line.equalsIgnoreCase(STOP_ALARM_REQUEST)) {
							log.debug("Closing session due client request.");
							break readingFromClient;
						} else {
							log.warn("Wrong client request");
							continue readingFromClient;
						}
					}
				}
			}

			log.debug("Overall message from " + server.getInetAddress()
					+ " is:" + input);
			log.debug("\nClosing session with " + server.getInetAddress()
					+ "...\n\n");
			server.close();
		} catch (IOException ioe) {
			log.warn("IOException on socket listen: " + ioe, ioe);
		}
	}

