    /**
     * Parses the magic-users.properties file into two mappings: from magic
     * username to password, and from magic role to authorized users of that
     * role.
     */
    public void parseMagicUsers() throws DataRetrievalFailureException {
        HashMap<String, OnmsUser> magicUsers = new HashMap<String, OnmsUser>();
        Map<String, Collection<? extends GrantedAuthority>> roles = new HashMap<String, Collection<? extends GrantedAuthority>>();

        long lastModified = new File(m_magicUsersConfigurationFile).lastModified();

        // read the file
        Properties properties = new Properties();
        try {
            properties.load(new FileInputStream(m_magicUsersConfigurationFile));
        } catch (FileNotFoundException e) {
            throw new DataRetrievalFailureException("Magic users configuration file '" + m_magicUsersConfigurationFile + "' not found: " + e.getMessage(), e);
        } catch (IOException e) {
            throw new DataRetrievalFailureException("Error reading magic users configuration file '" + m_magicUsersConfigurationFile + "': " + e.getMessage(), e);
        }

        // look up users and their passwords
        String[] configuredUsers = BundleLists.parseBundleList(properties.getProperty("users"));

        for (String user : configuredUsers) {
            String username = properties.getProperty("user." + user + ".username");
            String password = properties.getProperty("user." + user + ".password");

            OnmsUser newUser = null;
            try {
                newUser = m_userManager.getOnmsUser(user);
            } catch (final Exception ioe) {
                throw new DataRetrievalFailureException("Unable to read user " + user + " from users.xml", ioe);
            }
            
            if (newUser == null) {
                newUser = new OnmsUser();
                newUser.setUsername(username);
                newUser.setPassword(m_userManager.encryptedPassword(password, true));
                newUser.setPasswordSalted(true);
            }

            magicUsers.put(username, newUser);
        }

        String[] configuredRoles = BundleLists.parseBundleList(properties.getProperty("roles"));
        // Use roles from the groups.xml file if specified in applicationContext-spring-security.xml
        Map<String, LinkedList<String>> roleMap = m_useGroups ? parseGroupRoles() 
                                                              : new HashMap<String, LinkedList<String>>();
        Map<String, Boolean> roleAddDefaultMap = new HashMap<String, Boolean>();
        for (final String role : configuredRoles) {
            final String rolename = properties.getProperty("role." + role + ".name");
            if (rolename == null) {
                  LOG.warn("Role configuration for '{}' does not have 'name' parameter.  Expecting a 'role.{}.name' property. The role will not be usable.", role, role);
                  continue;
            }

            String userList = properties.getProperty("role." + role + ".users");
            if (userList == null) {
                LOG.warn("Role configuration for '{}' does not have 'users' parameter.  Expecting a 'role.{}.users' property. The role will not be usable.", role, role);
                continue;
            }
            String[] authUsers = BundleLists.parseBundleList(userList);

            boolean notInDefaultGroup = "true".equals(properties.getProperty("role." + role + ".notInDefaultGroup"));

            String securityRole = Authentication.getSpringSecurityRoleFromOldRoleName(rolename);
            if (securityRole == null) {
                final String newRolename = role.replaceAll("[^\\p{Alnum}]+", "_");
                if (newRolename.matches("^[Rr][Oo][Ll][Ee]_")) {
                    securityRole = newRolename.replaceAll("^[Rr][Oo][Ll][Ee]_", "ROLE_");
                } else {
                    securityRole = "ROLE_" + newRolename;
                }
                LOG.warn("Role '{}' does not have an old (hardcoded) role name!  Returning '{}'.", role, securityRole);
            }

            for (String authUser : authUsers) {
                if (roleMap.get(authUser) == null) {
                    roleMap.put(authUser, new LinkedList<String>());
                }
                LinkedList<String> userRoleList = roleMap.get(authUser); 
                userRoleList.add(securityRole);
            }
            
            roleAddDefaultMap.put(securityRole, !notInDefaultGroup);
        }

        for (final Entry<String, LinkedList<String>> entry : roleMap.entrySet()) {
            roles.put(entry.getKey(), getAuthorityListFromRoleList(entry.getValue(), roleAddDefaultMap));
        }
        
        LOG.debug("Loaded the magic-users.properties file with {} magic users, {} roles, and {} user roles", magicUsers.size(), configuredRoles.length, roles.size());


        m_magicUsersLastModified = lastModified; 
        m_magicUsers = magicUsers;
        m_roles = roles;
    }

