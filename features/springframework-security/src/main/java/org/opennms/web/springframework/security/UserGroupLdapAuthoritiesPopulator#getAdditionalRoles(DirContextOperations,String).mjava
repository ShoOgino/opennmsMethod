	/**
	 *
	 * This function returns a list of roles from the given set of groups
	 * based on the value of the <code>groupToRoleMap</code> property.
	 * 
	 * @return a {@link java.util.Set} object.
	 */
	@Override
	protected Set<GrantedAuthority> getAdditionalRoles(DirContextOperations user, String username) {
		String userDn = user.getNameInNamespace();
		Set<GrantedAuthority> authorities = new HashSet<GrantedAuthority>();

		if (getGroupSearchBase() == null) {
			return authorities;
		}

		if (logger.isDebugEnabled()) {
			logger.debug("Searching for roles for user '" + username + "', DN = " + "'" + userDn + "', with filter "
					+ groupSearchFilter + " in search base '" + getGroupSearchBase() + "'");
		}

		@SuppressWarnings("unchecked")
		Set<String> userRoles = ldapTemplate.searchForSingleAttributeValues(
				getGroupSearchBase(), 
				groupSearchFilter,
				new String[]{userDn, username}, 
				groupRoleAttribute
		);

		for(String group : userRoles) {
			List<String> rolesForGroup = groupToRoleMap.get(group);
			logger.debug("Checking " + group + " for an associated role");
			if (rolesForGroup != null) {
				for(String role : rolesForGroup) {
					authorities.add(new GrantedAuthorityImpl(role));
					logger.debug("Added role: " + role + " based on group " + group);
				}
			}
		}

		return authorities;
	}

