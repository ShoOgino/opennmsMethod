    @Test
    public void canGatherCpuMetrics() {
        // Define our configuration
        Collection collection = new Collection();
        Group nodeExporterCpu = new Group();
        nodeExporterCpu.setName("node-exporter-cpu");
        nodeExporterCpu.setFilterExp("name matches 'node_cpu'");
        nodeExporterCpu.setGroupByExp("labels[cpu]");
        nodeExporterCpu.setResourceType("nodeExporterCPU");

        NumericAttribute attribute = new NumericAttribute();
        attribute.setAliasExp("labels[mode]");
        nodeExporterCpu.getNumericAttribute().add(attribute);

        // Define the resource type
        ResourceType resourceType = createStandardResourceType("nodeExporterCPU");
        ResourceTypeMapper.getInstance().setResourceTypeMapper((rt) -> resourceType);
        
        // Collect!
        CollectionSet collectionSet = collect(collection, Lists.newArrayList(nodeExporterCpu));

        // Verify
        List<String> collectionSetKeys = CollectionSetUtils.flatten(collectionSet);
        assertEquals(Arrays.asList("0/nodeExporterCPU/cpu0/node-exporter-cpu/guest[null,0.0]",
                "0/nodeExporterCPU/cpu0/node-exporter-cpu/idle[null,16594.88]",
                "0/nodeExporterCPU/cpu0/node-exporter-cpu/iowait[null,163.99]",
                "0/nodeExporterCPU/cpu0/node-exporter-cpu/irq[null,62.55]",
                "0/nodeExporterCPU/cpu0/node-exporter-cpu/nice[null,1134.72]",
                "0/nodeExporterCPU/cpu0/node-exporter-cpu/softirq[null,58.2]",
                "0/nodeExporterCPU/cpu0/node-exporter-cpu/steal[null,0.0]",
                "0/nodeExporterCPU/cpu0/node-exporter-cpu/system[null,316.98]",
                "0/nodeExporterCPU/cpu0/node-exporter-cpu/user[null,1638.27]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/guest[null,0.0]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/idle[null,17790.51]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/iowait[null,71.6]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/irq[null,39.27]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/nice[null,660.0]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/softirq[null,34.22]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/steal[null,0.0]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/system[null,207.24]",
                "0/nodeExporterCPU/cpu1/node-exporter-cpu/user[null,1182.24]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/guest[null,0.0]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/idle[null,16907.35]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/iowait[null,134.94]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/irq[null,35.18]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/nice[null,928.18]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/softirq[null,23.12]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/steal[null,0.0]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/system[null,316.74]",
                "0/nodeExporterCPU/cpu2/node-exporter-cpu/user[null,1616.54]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/guest[null,0.0]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/idle[null,17780.12]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/iowait[null,52.55]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/irq[null,26.66]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/nice[null,696.89]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/softirq[null,9.73]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/steal[null,0.0]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/system[null,203.84]",
                "0/nodeExporterCPU/cpu3/node-exporter-cpu/user[null,1217.81]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/guest[null,0.0]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/idle[null,16817.38]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/iowait[null,121.42]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/irq[null,29.09]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/nice[null,986.56]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/softirq[null,12.99]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/steal[null,0.0]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/system[null,311.9]",
                "0/nodeExporterCPU/cpu4/node-exporter-cpu/user[null,1696.0]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/guest[null,0.0]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/idle[null,17891.54]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/iowait[null,44.88]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/irq[null,20.32]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/nice[null,570.46]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/softirq[null,7.6]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/steal[null,0.0]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/system[null,202.13]",
                "0/nodeExporterCPU/cpu5/node-exporter-cpu/user[null,1252.44]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/guest[null,0.0]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/idle[null,16782.14]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/iowait[null,146.53]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/irq[null,26.75]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/nice[null,1001.04]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/softirq[null,12.32]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/steal[null,0.0]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/system[null,300.31]",
                "0/nodeExporterCPU/cpu6/node-exporter-cpu/user[null,1705.1]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/guest[null,0.0]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/idle[null,17955.02]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/iowait[null,49.39]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/irq[null,17.68]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/nice[null,553.09]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/softirq[null,7.85]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/steal[null,0.0]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/system[null,200.86]",
                "0/nodeExporterCPU/cpu7/node-exporter-cpu/user[null,1203.71]"), collectionSetKeys);
    }

