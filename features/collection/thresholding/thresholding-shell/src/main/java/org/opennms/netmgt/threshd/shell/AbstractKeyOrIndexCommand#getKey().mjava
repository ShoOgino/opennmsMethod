    protected String getKey() {
        Integer index = null;
        String key = null;

        // Try to derive an index from the passed argument and map it to a key in the session
        try {
            index = Integer.parseInt(keyOrIndex);

            Object stateKeyIndexes = session.get(STATE_INDEXES_SESSION_KEY);

            if (stateKeyIndexes == null) {
                throw new IllegalStateException("The state key index has not been populated by the enumerate command");
            }

            key = ((Map<Integer, String>) stateKeyIndexes).get(index);

            if (key == null) {
                throw new IllegalArgumentException("Could not find a state mapped to index " + index);
            }
        } catch (NumberFormatException ignore) {
        }

        // If there wasn't a valid index treat the argument as the key for hte state
        if (index == null) {
            key = keyOrIndex;
        }

        return key;
    }

