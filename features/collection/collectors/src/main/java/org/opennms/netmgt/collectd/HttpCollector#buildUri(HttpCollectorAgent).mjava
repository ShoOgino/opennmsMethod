    private static URI buildUri(final HttpCollectorAgent collectorAgent) throws URISyntaxException {
        HashMap<String,String> substitutions = new HashMap<String,String>();
        substitutions.put("ipaddr", InetAddressUtils.str(collectorAgent.getAgent().getAddress()));
        substitutions.put("nodeid", Integer.toString(collectorAgent.getAgent().getNodeId()));

        final URIBuilder ub = new URIBuilder();
        ub.setScheme(collectorAgent.getUriDef().getUrl().getScheme());
        ub.setHost(substituteKeywords(substitutions, collectorAgent.getUriDef().getUrl().getHost(), "getHost"));
        ub.setPort(collectorAgent.getPort());
        ub.setPath(substituteKeywords(substitutions, collectorAgent.getUriDef().getUrl().getPath(), "getURL"));

        final String query = substituteKeywords(substitutions, collectorAgent.getUriDef().getUrl().getQuery(), "getQuery");
        final List<NameValuePair> params = URLEncodedUtils.parse(query, Charset.forName("UTF-8"));
        ub.setParameters(params);

        ub.setFragment(substituteKeywords(substitutions, collectorAgent.getUriDef().getUrl().getFragment(), "getFragment"));
        return ub.build();
    }

