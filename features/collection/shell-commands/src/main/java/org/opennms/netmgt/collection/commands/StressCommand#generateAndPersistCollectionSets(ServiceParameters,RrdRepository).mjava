    private void generateAndPersistCollectionSets(ServiceParameters params, RrdRepository repository) {
        for (int nodeId = 0; nodeId < numberOfNodes; nodeId++) {
            // Build the node resource
            CollectionAgent agent = new MockCollectionAgent(nodeId);
            NodeLevelResource nodeResource = new NodeLevelResource(nodeId);

            // Don't reuse the persister instance across nodes to help simulate collectd's actual behavior
            Persister persister = persisterFactory.createPersister(params, repository);
            for (int interfaceId = 0; interfaceId < numberOfInterfacesPerNode; interfaceId++) {
                // Return immediately if the abort flag is set
                if (abort.get()) {
                    return;
                }

                // Build the interface resource
                InterfaceLevelResource interfaceResource = new InterfaceLevelResource(nodeResource, "tap" + interfaceId);

                // Generate the collection set
                CollectionSet collectionSet = generateCollectionSet(agent, interfaceResource);

                // Persist
                collectionSet.visit(persister);
            }
        }
    }

