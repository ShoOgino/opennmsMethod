    private DHCPPacket createPacket(int xid, TransactionImpl transaction, byte messageType) {
        final DHCPPacket dhcpPacket = new DHCPPacket();

        dhcpPacket.setOp(BOOTREQUEST);
        dhcpPacket.setDHCPMessageType(messageType);

        dhcpPacket.setHtype(HTYPE_ETHER);
        dhcpPacket.setHlen((byte) 6);
        dhcpPacket.setChaddr(transaction.getMacAddress());
        dhcpPacket.setXid(xid);
        dhcpPacket.setSecs((short) 0);

        if (transaction.isRelayMode()) {
            dhcpPacket.setGiaddr(transaction.getMyIpAddress());
            dhcpPacket.setHops((byte) 1);
        } else {
            dhcpPacket.setHops((byte) 0);
            dhcpPacket.setFlags((short) 0x8000);
        }

        switch (dhcpPacket.getDHCPMessageType()) {
            case DHCPREQUEST: {
                dhcpPacket.setOption(DHCPOption.newOptionAsInetAddress(DHO_DHCP_REQUESTED_ADDRESS, transaction.getRequestIpAddress()));
                dhcpPacket.setCiaddr(transaction.getRequestIpAddress());
                break;
            }
            case DHCPINFORM: {
                dhcpPacket.setOption(DHCPOption.newOptionAsInetAddress(DHO_DHCP_REQUESTED_ADDRESS, transaction.getMyIpAddress()));
                dhcpPacket.setCiaddr(transaction.getMyIpAddress());
                break;
            }
        }

        return dhcpPacket;
    }

