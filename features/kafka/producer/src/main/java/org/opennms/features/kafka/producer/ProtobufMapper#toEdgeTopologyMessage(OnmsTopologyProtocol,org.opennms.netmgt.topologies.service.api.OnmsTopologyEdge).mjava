    public OpennmsModelProtos.TopologyEdge toEdgeTopologyMessage(OnmsTopologyProtocol protocol,
                                                                 org.opennms.netmgt.topologies.service.api.OnmsTopologyEdge edge) {

        OpennmsModelProtos.TopologyEdge.Builder edgeBuilder = OpennmsModelProtos.TopologyEdge.newBuilder();
        edgeBuilder.setRef(getTopologyRef(protocol, edge.getId()));

        // Set the source
        if (edge.getSource().getVertex().getNodeid() == null) {
            // Source is a segment
            edgeBuilder.setSourceSegment(getSegment(edge.getSource(), protocol));
        } else if (edge.getSource().getIfindex() != null && edge.getSource().getIfindex() >= 0) {
            // Source is a port
            edgeBuilder.setSourcePort(getPort(edge.getSource()));
        } else {
            // Source is a node
            edgeBuilder.setSourceNode(getNode(edge.getSource()));
        }

        // Set the target
        if (edge.getTarget().getVertex().getNodeid() == null) {
            // Target is a segment
            edgeBuilder.setTargetSegment(getSegment(edge.getTarget(), protocol));
        } else if (edge.getTarget().getIfindex() != null && edge.getTarget().getIfindex() >= 0) {
            // Target is a port
            edgeBuilder.setTargetPort(getPort(edge.getTarget()));
        } else {
            // Target is a node
            edgeBuilder.setTargetNode(getNode(edge.getTarget()));
        }
        
        return edgeBuilder.build();
    }

