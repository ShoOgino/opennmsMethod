    /**
     * Test method for {@link org.opennms.netmgt.ticketd.DefaultTicketerServiceLayer#closeTicketForAlarm(int, java.lang.String)}.
     * Tests for correct alarm TroubleTicketState set as CLOSE_FAILED when ticketer plugin fails
     * @throws PluginException 
     */
    @Test
    public void testFailedCloseTicketForAlarm() throws PluginException {
        EasyMock.expect(m_alarmDao.get(m_alarm.getId())).andReturn(m_alarm);

        m_ticketerPlugin.get(m_ticket.getId());

        EasyMock.expectLastCall().andThrow(new PluginException("Failed Close"));

        expectNewAlarmState(TroubleTicketState.CLOSE_FAILED);

        m_alarm.setSeverity(OnmsSeverity.CLEARED);

        expectAnUpdateToAlarmNotifier(null, TroubleTicketState.CLOSE_FAILED);

        m_easyMockUtils.replayAll();

        m_defaultTicketerServiceLayer.closeTicketForAlarm(m_alarm.getId(), m_ticket.getId());

        m_easyMockUtils.verifyAll();
    }

