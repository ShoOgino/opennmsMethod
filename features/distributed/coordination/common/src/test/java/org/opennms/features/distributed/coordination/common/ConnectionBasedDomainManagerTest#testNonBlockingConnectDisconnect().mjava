    /**
     * Tests that connecting and disconnecting occurs in a separate thread.
     *
     * @throws Exception
     */
    @Test
    public void testNonBlockingConnectDisconnect() throws Exception {
        TestDomainManager manager = new TestDomainManager(domain);

        manager.register(id, (role, domain) -> {});
        waitForFuture(connectThreadFuture);

        manager.deregister(id);
        waitForFuture(disconnectThreadFuture);
    }

