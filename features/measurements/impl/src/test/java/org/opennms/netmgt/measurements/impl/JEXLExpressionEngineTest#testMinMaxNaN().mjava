    @Test
    public void testMinMaxNaN() throws ExpressionException {
        final String minExpression = "( ( A == NaN ) ? B : ( ( B == NaN ) ? A : math:min(A,B) ) )";
        final String maxExpression = "( ( A == NaN ) ? B : ( ( B == NaN ) ? A : math:max(A,B) ) )";

        // a = min, b = max, c = value
        final double small = 1.0;
        final double large = 100.0;
        final Map<String,Object> entries = Maps.newHashMap();

        // min: small is smaller than large
        entries.put("A", small);
        entries.put("B", large);
        double results[] = performExpression(minExpression, entries);
        assertEquals(small, results[0], DELTA);

        // min: small is smaller than large
        entries.put("A", large);
        entries.put("B", small);
        results = performExpression(minExpression, entries);
        assertEquals(small, results[0], DELTA);

        // min: small is same as small
        entries.put("A", small);
        entries.put("B", small);
        results = performExpression(minExpression, entries);
        assertEquals(small, results[0], DELTA);

        // min: value and unknown is value
        entries.put("A", small);
        entries.put("B", Double.NaN);
        results = performExpression(minExpression, entries);
        assertEquals(small, results[0], DELTA);

        // min: unknown and value is value
        entries.put("A", Double.NaN);
        entries.put("B", small);
        results = performExpression(minExpression, entries);
        assertEquals(small, results[0], DELTA);

        // max: large is larger than small
        entries.put("A", small);
        entries.put("B", large);
        results = performExpression(maxExpression, entries);
        assertEquals(large, results[0], DELTA);

        // max: large is larger than small
        entries.put("A", large);
        entries.put("B", small);
        results = performExpression(maxExpression, entries);
        assertEquals(large, results[0], DELTA);

        // max: large is same as large
        entries.put("A", large);
        entries.put("B", large);
        results = performExpression(maxExpression, entries);
        assertEquals(large, results[0], DELTA);

        // max: value and unknown is value
        entries.put("A", small);
        entries.put("B", Double.NaN);
        results = performExpression(maxExpression, entries);
        assertEquals(small, results[0], DELTA);

        // max: unknown and value is value
        entries.put("A", Double.NaN);
        entries.put("B", small);
        results = performExpression(maxExpression, entries);
        assertEquals(small, results[0], DELTA);
    }

