    public static String getConvoKeyAsJsonString(FlowDocument document) {
        // Only generate the key if all of the required fields are set
        if (document.getLocation() != null
                && document.getProtocol() != null
                && document.getSrcAddr() != null
                && document.getDstAddr() != null) {
            // Build the JSON string manually
            // This is faster than creating some new object on which we can use gson.toJson or similar
            final StringWriter writer = new StringWriter();
            writer.write("[");
            // Use GSON to encode the location, since this may contain characters that need to be escape
            writer.write(gson.toJson(document.getLocation()));
            writer.write(",");
            writer.write(Integer.toString(document.getProtocol()));
            writer.write(",\"");
            // Write out addresses in canonical format (lower one first)
            if (Objects.compare(document.getSrcAddr(), document.getDstAddr(), String::compareTo) < 0) {
                writer.write(document.getSrcAddr());
                writer.write("\",\"");
                writer.write(document.getDstAddr());
            } else {
                writer.write(document.getDstAddr());
                writer.write("\",\"");
                writer.write(document.getSrcAddr());
            }
            writer.write("\",");
            if (document.getApplication() != null) {
                writer.write("\"");
                writer.write(document.getApplication());
                writer.write("\"");
            } else {
                writer.write("null");
            }
            writer.write("]");
            return writer.toString();
        }
        return null;
    }

