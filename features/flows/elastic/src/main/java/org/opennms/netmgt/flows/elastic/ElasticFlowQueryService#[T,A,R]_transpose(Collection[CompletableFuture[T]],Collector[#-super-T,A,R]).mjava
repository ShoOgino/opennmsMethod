    protected static <T, A, R> CompletableFuture<R> transpose(final Collection<CompletableFuture<T>> futures,
                                                              final Collector<? super T, A, R> collector) {
        return CompletableFuture.allOf(Iterables.toArray(futures, CompletableFuture.class))
                .thenApply(v -> futures.stream()
                        .map(CompletableFuture::join)
                        .collect(collector));
    }

