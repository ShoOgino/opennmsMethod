    protected static <T, A, R> CompletableFuture<R> transpose(final Iterable<CompletableFuture<T>> futures,
                                                              final Collector<? super T, A, R> collector) {
        final CompletableFuture<T>[] array = Iterables.toArray(futures, CompletableFuture.class);
        return CompletableFuture.allOf(array)
                                .thenApply(v -> Arrays.stream(array)
                        .map(CompletableFuture::join)
                        .collect(collector));
    }

