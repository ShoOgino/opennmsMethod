    private void collectGroupUsing(Group group, CollectionAgent agent, WSManClient client, int retries, CollectionSetBuilder builder) throws CollectionException {
        // Determine the appropriate resource type
        final NodeLevelResource nodeResource = new NodeLevelResource(agent.getNodeId());
        Resource effectiveResource = nodeResource;
        if (!"node".equalsIgnoreCase(group.getResourceType())) {
            final ResourceType resourceType = m_resourceTypesDao.getResourceTypeByName(group.getResourceType());
            if (resourceType == null) {
                throw new CollectionException("No resource type found with name '" + group.getResourceType() + "'.");
            }
            effectiveResource = new GenericTypeResourceWithoutInstance(nodeResource, resourceType);
        }
        LOG.debug("Using resource {} for group named {}", effectiveResource, group.getName());

        // Enumerate
        List<Node> nodes = Lists.newLinkedList();
        RetryNTimesLoop retryLoop = new RetryNTimesLoop(retries);
        while (retryLoop.shouldContinue()) {
            try {
                if (group.getFilter() == null) {
                    LOG.debug("Enumerating and pulling {} on {}.", group.getResourceUri(), client);
                    client.enumerateAndPull(group.getResourceUri(), nodes, true);
                } else {
                    LOG.debug("Enumerating and pulling {} with dialect {} and filter {} on {}.", group.getResourceUri(),
                            group.getDialect(), group.getFilter(), client);
                    client.enumerateAndPullUsingFilter(group.getResourceUri(), group.getDialect(), group.getFilter(), nodes, true);
                }
                break;
            } catch (WSManException e) {
                retryLoop.takeException(e);
            }
        }
        LOG.debug("Found {} nodes.", nodes.size());

        // Process the results
        processEnumerationResults(group, builder, effectiveResource, nodes);
    }

