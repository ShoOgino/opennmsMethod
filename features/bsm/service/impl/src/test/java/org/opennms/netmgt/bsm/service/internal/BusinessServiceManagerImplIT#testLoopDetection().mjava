    @Test
    public void testLoopDetection() {
        BusinessService service1 = createService("Business Service #1");
        BusinessService service2 = createService("Business Service #2");
        BusinessService service3 = createService("Business Service #3");

        Long serviceId1 = businessServiceDao.save(service1);
        Long serviceId2 = businessServiceDao.save(service2);
        Long serviceId3 = businessServiceDao.save(service3);

        Assert.assertEquals(ImmutableSet.of(businessServiceManager.getById(serviceId2),
                                            businessServiceManager.getById(serviceId3)),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId1)));
        Assert.assertEquals(ImmutableSet.of(businessServiceManager.getById(serviceId1),
                                            businessServiceManager.getById(serviceId3)),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId2)));
        Assert.assertEquals(ImmutableSet.of(businessServiceManager.getById(serviceId1),
                                            businessServiceManager.getById(serviceId2)),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId3)));

        businessServiceManager.assignChildService(serviceId1, serviceId2);

        Assert.assertEquals(ImmutableSet.of(businessServiceManager.getById(serviceId2),
                                            businessServiceManager.getById(serviceId3)),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId1)));
        Assert.assertEquals(ImmutableSet.of(businessServiceManager.getById(serviceId3)),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId2)));
        Assert.assertEquals(ImmutableSet.of(businessServiceManager.getById(serviceId1),
                                            businessServiceManager.getById(serviceId2)),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId3)));

        businessServiceManager.assignChildService(serviceId2, serviceId3);

        Assert.assertEquals(ImmutableSet.of(businessServiceManager.getById(serviceId2),
                                            businessServiceManager.getById(serviceId3)),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId1)));
        Assert.assertEquals(ImmutableSet.of(businessServiceManager.getById(serviceId3)),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId2)));
        Assert.assertEquals(ImmutableSet.of(),
                            businessServiceManager.getFeasibleChildServices(businessServiceManager.getById(serviceId3)));
    }

