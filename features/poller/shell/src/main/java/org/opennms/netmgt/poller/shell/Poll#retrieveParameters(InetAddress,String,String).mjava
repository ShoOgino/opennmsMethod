    private Map<String, Object> retrieveParameters(final InetAddress ipAddress, final String packageName, final String serviceName) throws Exception {
        final Map<String, Object> parameters = new TreeMap<>();

        if (serviceName == null) {
            return parameters;
        }

        final PollerConfig pollerConfig = ReadOnlyPollerConfigManager.create();

        final org.opennms.netmgt.config.poller.Package pkg = packageName == null ? pollerConfig.getFirstLocalPackageMatch(InetAddressUtils.str(ipAddress)) : pollerConfig.getPackage(packageName);
        if (pkg == null) {
            System.err.printf("Error: Package %s doesn't exist%n", packageName);
            return parameters;
        }

        final org.opennms.netmgt.config.poller.Service svc = pollerConfig.getServiceInPackage(serviceName, pkg);
        if (svc == null) {
            System.err.printf("Error: Service %s not defined on package %s%n", serviceName, packageName);
            return parameters;
        }

        final Optional<Package.ServiceMatch> service = pkg.findService(serviceName);
        if (!service.isPresent()) {
            System.err.printf("Error: Service %s not defined%n", serviceName);
            return parameters;
        }

        for(final Parameter parameter : svc.getParameters()) {
            String value = parameter.getValue();

            if (value == null) {
                try {
                    value = JaxbUtils.marshal(parameter.getAnyObject());
                } catch (Exception e) {}
            }

            parameters.put(parameter.getKey(), value);
        }

        return parameters;
    }

