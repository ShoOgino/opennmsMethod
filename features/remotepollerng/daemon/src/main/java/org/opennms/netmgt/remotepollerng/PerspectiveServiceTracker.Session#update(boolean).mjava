        public void update(final boolean dirty) {
            // Mark as dirty if requested
            this.dirty |= dirty;

            // If still not marked as dirty, there is nothing to do
            if (!this.dirty) {
                return;
            }

            // Check if it's time to refresh
            if (this.lastRefresh.isAfter(Instant.now().minusMillis(PerspectiveServiceTracker.REFRESH_RATE_LIMIT_MS))) {
                return;
            }

            // Refresh the service list
            PerspectiveServiceTracker.this.sessionUtils.withReadOnlyTransaction(() -> {
                final Map<ServicePerspectiveRef, ServicePerspective> candidates = PerspectiveServiceTracker.this.applicationDao.getServicePerspectives().stream()
                                                                                                                               .collect(Collectors.toMap(ServicePerspectiveRef::from, Function.identity()));

                final Set<ServicePerspectiveRef> current = Sets.newHashSet(this.active);
                final Set<ServicePerspectiveRef> additions = Sets.difference(candidates.keySet(), current);
                final Set<ServicePerspectiveRef> removals = Sets.difference(current, candidates.keySet());

                for (final ServicePerspectiveRef servicePerspective : additions) {
                    this.active.add(servicePerspective);
                    this.listener.onServicePerspectiveAdded(servicePerspective, candidates.get(servicePerspective));
                }

                for (final ServicePerspectiveRef servicePerspective : removals) {
                    this.active.remove(servicePerspective);
                    this.listener.onServicePerspectiveRemoved(servicePerspective);
                }

                return null;
            });

            // Not dirty anymore after a successful refresh
            this.lastRefresh = Instant.now();
            this.dirty = false;
        }

