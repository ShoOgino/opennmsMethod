    private Runnable waitForNAlarmsInES(int numAlarms) {
        return () -> {
            // Don't tear down until we have the expected number of alarms in ES and they are all marked as deleted.
            await().atMost(1, TimeUnit.MINUTES).pollInterval(5, TimeUnit.SECONDS)
                    .until(() -> alarmHistoryRepo.getLastStateOfAllAlarms(0, System.currentTimeMillis()),
                            hasSize(equalTo(numAlarms)));
            // All of the alarms are in ES now, wait until they are deleted
            await().atMost(1, TimeUnit.MINUTES).pollInterval(5, TimeUnit.SECONDS)
                    .until(() -> alarmHistoryRepo.getLastStateOfAllAlarms(0, System.currentTimeMillis()),
                            everyItem(ExtAlarmsMatchers.wasDeleted()));
        };
    }

