    @Test
    public void canMaintainMultipleStateChanges() {
        Scenario scenario = Scenario.builder()
                .withLegacyAlarmBehavior()
                .withNodeDownEvent(1, 1)
                .withAcknowledgmentForNodeDownAlarm(2, 1)
                .withUnAcknowledgmentForNodeDownAlarm(3, 1)
                .withAcknowledgmentForNodeDownAlarm(4, 1)
                .withUnAcknowledgmentForNodeDownAlarm(5, 1)
                .awaitUntil(waitForNAlarmsInES(1))
                .build();
        // Execute the scenario
        ScenarioResults scenarioResults = scenario.play();

        // Verify the set of alarms at various points in time

        // t=0, no alarms
        assertThat(scenarioResults.getAlarms(0), hasSize(0));

        assertThat(alarmHistoryRepo.getActiveAlarmsAt(0), hasSize(0));

        // t=1, a single problem alarm that is not yet acknowledged
        assertThat(scenarioResults.getAlarms(1), hasSize(1));
        assertThat(scenarioResults.getProblemAlarm(1), hasSeverity(OnmsSeverity.MAJOR));
        assertThat(scenarioResults.getProblemAlarm(1), not(acknowledged()));

        assertThat(alarmHistoryRepo.getActiveAlarmsAt(1), hasSize(1));
        assertThat(getProblemAlarmAt(1), ExtAlarmsMatchers.hasSeverity(OnmsSeverity.MAJOR));
        assertThat(getProblemAlarmAt(1), not(ExtAlarmsMatchers.acknowledged()));

        // t=2, a single problem alarm that is acknowledged
        assertThat(scenarioResults.getAlarms(2), hasSize(1));
        assertThat(scenarioResults.getProblemAlarm(2), hasSeverity(OnmsSeverity.MAJOR));
        assertThat(scenarioResults.getProblemAlarm(2), acknowledged());

        assertThat(alarmHistoryRepo.getActiveAlarmsAt(2), hasSize(1));
        assertThat(getProblemAlarmAt(2), ExtAlarmsMatchers.hasSeverity(OnmsSeverity.MAJOR));
        assertThat(getProblemAlarmAt(2), ExtAlarmsMatchers.acknowledged());

        // t=3, a single problem alarm that is no longer acknowledged
        assertThat(scenarioResults.getAlarms(3), hasSize(1));
        assertThat(scenarioResults.getProblemAlarm(3), hasSeverity(OnmsSeverity.MAJOR));
        assertThat(scenarioResults.getProblemAlarm(3), not(acknowledged()));

        assertThat(alarmHistoryRepo.getActiveAlarmsAt(3), hasSize(1));
        assertThat(getProblemAlarmAt(3), ExtAlarmsMatchers.hasSeverity(OnmsSeverity.MAJOR));
        assertThat(getProblemAlarmAt(3), not(ExtAlarmsMatchers.acknowledged()));

        // t=4, a single problem alarm that is acknowledged
        assertThat(scenarioResults.getAlarms(4), hasSize(1));
        assertThat(scenarioResults.getProblemAlarm(4), hasSeverity(OnmsSeverity.MAJOR));
        assertThat(scenarioResults.getProblemAlarm(4), acknowledged());

        assertThat(alarmHistoryRepo.getActiveAlarmsAt(4), hasSize(1));
        assertThat(getProblemAlarmAt(4), ExtAlarmsMatchers.hasSeverity(OnmsSeverity.MAJOR));
        assertThat(getProblemAlarmAt(4), ExtAlarmsMatchers.acknowledged());

        // t=5, a single problem alarm that is no longer acknowledged
        assertThat(scenarioResults.getAlarms(5), hasSize(1));
        assertThat(scenarioResults.getProblemAlarm(5), hasSeverity(OnmsSeverity.MAJOR));
        assertThat(scenarioResults.getProblemAlarm(5), not(acknowledged()));

        assertThat(alarmHistoryRepo.getActiveAlarmsAt(5), hasSize(1));
        assertThat(getProblemAlarmAt(5), ExtAlarmsMatchers.hasSeverity(OnmsSeverity.MAJOR));
        assertThat(getProblemAlarmAt(5), not(ExtAlarmsMatchers.acknowledged()));

        // t=âˆž
        Long lastKnownTime = scenarioResults.getLastKnownTime();
        assertThat(scenarioResults.getAlarms(lastKnownTime), hasSize(0));
        assertThat(alarmHistoryRepo.getActiveAlarmsAt(lastKnownTime), hasSize(0));
    }

