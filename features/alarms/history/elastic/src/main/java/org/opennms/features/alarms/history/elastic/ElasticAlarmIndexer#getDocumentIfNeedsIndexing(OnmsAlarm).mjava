    @VisibleForTesting
    Optional<AlarmDocumentDTO> getDocumentIfNeedsIndexing(OnmsAlarm alarm) {
        final AlarmDocumentDTO existingAlarmDocument = alarmDocumentsById.get(alarm.getId());

        boolean needsIndexing = false;
        if (indexAllUpdates) {
            needsIndexing = true;
        } else if (existingAlarmDocument == null) {
            needsIndexing = true;
        } else if (getCurrentTimeMillis() - existingAlarmDocument.getUpdateTime() >= alarmReindexDurationMs) {
            needsIndexing = true;
        } else if (!interestingEquals(existingAlarmDocument, alarm)) {
            needsIndexing = true;
        }

        if (needsIndexing) {
            final AlarmDocumentDTO doc = documentMapper.apply(alarm);
            alarmDocumentsById.put(alarm.getId(), doc);
            return Optional.of(doc);
        }

        return Optional.empty();
    }

