	public static Map<String,Number> executeSequence(MobileSequenceConfig sequenceConfig, Properties session) throws Throwable {
		initialize();
		MobileMsgSequenceBuilder sequenceBuilder = new MobileMsgSequenceBuilder();
		sequenceBuilder.setDefaultRetries(Integer.parseInt(session.getProperty("retry", String.valueOf(sequenceBuilder.getDefaultRetries()))));
		sequenceBuilder.setDefaultTimeout(Long.parseLong(session.getProperty("timeout", String.valueOf(sequenceBuilder.getDefaultTimeout()))));

		Map<String,SessionVariableGenerator> sessionGenerators = new HashMap<String,SessionVariableGenerator>();

		// FIXME: use the service registry for this
		for (SequenceSessionVariable var : sequenceConfig.getSessionVariables()) {
			Class<?> c = Class.forName(var.getClassName());

			Class<?> superclass = c.getSuperclass();
			if (superclass != null && superclass.getName().equals("org.opennms.sms.monitor.session.BaseSessionVariableGenerator")) {
				SessionVariableGenerator generator = (SessionVariableGenerator)c.newInstance();
				generator.setParameters(var.getParametersAsMap());
				sessionGenerators.put(var.getName(), generator);
				String value = generator.checkOut();
				if (value == null) {
					value = "";
				}
				session.setProperty(var.getName(), value);
			} else {
				log.warn("unable to get instance of session class: " + c);
			}
		}

		for (final MobileSequenceTransaction t : sequenceConfig.getTransactions()) {
			final MobileMsgTransactionBuilder transactionBuilder;

			if (t.getGatewayId() != null) {
				sequenceBuilder.setDefaultGatewayId(t.getGatewayId());
			}

			String label = t.getRequest().getLabel();
			if (label == null) label = t.getLabel();
			
			if (t.getRequest() instanceof SmsSequenceRequest) {
				SmsSequenceRequest req = (SmsSequenceRequest)t.getRequest();
				transactionBuilder = sequenceBuilder.sendSms(
					substitute(label, session),
					substitute(req.getGatewayId(), session),
					substitute(req.getRecipient(), session),
					substitute(req.getText(), session)
				);
			} else if (t.getRequest() instanceof UssdSequenceRequest) {
				UssdSequenceRequest req = (UssdSequenceRequest)t.getRequest();
				transactionBuilder = sequenceBuilder.sendUssd(
					substitute(label, session),
					substitute(req.getGatewayId(), session),
					substitute(req.getText(), session)
				);
			} else {
				throw new SequencerException("Unknown request type: " + t.getRequest());
			}
			
			for (MobileSequenceResponse r : t.getResponses()) {
				List<MobileMsgResponseMatcher> matchers = new ArrayList<MobileMsgResponseMatcher>();
				for (SequenceResponseMatcher m : r.getMatchers()) {
					matchers.add(m.getMatcher(session));
				}
				if (r instanceof SmsSequenceResponse) {
					matchers.add(isSms());
				} else if (r instanceof UssdSequenceResponse) {
					matchers.add(isUssd());
				}
				transactionBuilder.expects(and(matchers.toArray(new MobileMsgResponseMatcher[0])));
			}
		}

		MobileMsgSequence seq = sequenceBuilder.getSequence();
		if (log.isTraceEnabled()) {
			log.trace("MobileMsgSequence = " + seq);
		}
		try {
			long start = System.currentTimeMillis();
			Map<String,Number> responseTimes = seq.execute(s_tracker, s_coordinator);
			long end = System.currentTimeMillis();
			responseTimes.put("response-time", Long.valueOf(end - start));
			return responseTimes;
		} finally {
			for (Map.Entry<String, SessionVariableGenerator> generator : sessionGenerators.entrySet()) {
				generator.getValue().checkIn(session.getProperty(generator.getKey()));
			}
		}
	}

