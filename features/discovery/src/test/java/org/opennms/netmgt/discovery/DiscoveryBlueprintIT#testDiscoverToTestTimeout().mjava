    @Test
    public void testDiscoverToTestTimeout() throws Exception {

        /*
         * Create a Camel listener for the location queue that will respond with
         * {@link DiscoveryResult} objects.
         */
        SimpleRegistry registry = new SimpleRegistry();
        CamelContext mockDiscoverer = new DefaultCamelContext(registry);
        mockDiscoverer.addComponent("activemq", ActiveMQComponent.activeMQComponent("tcp://127.0.0.1:61616"));
        mockDiscoverer.addRoutes(new RouteBuilder() {
            @Override
            public void configure() throws Exception {
                String from = String.format("activemq:Location-%s", LOCATION);

                from(from)
                .process(new Processor() {
                    @Override
                    public void process(Exchange exchange) throws Exception {
                        DiscoveryJob job = exchange.getIn().getBody(DiscoveryJob.class);
                        String foreignSource = job.getForeignSource();
                        String location = job.getLocation();

                        // Sleep to trigger a timeout, make this greater than the timeout calculated below
                        Thread.sleep(15000);

                        Message out = exchange.getOut();
                        DiscoveryResults results = new DiscoveryResults(
                            Collections.singletonMap(InetAddressUtils.addr("4.2.2.2"), 1000L),
                            foreignSource,
                            location
                        );
                        out.setBody(results);
                    }
                });
            }
        });

        mockDiscoverer.start();

        final String ipAddress = "4.2.2.2";
        final String foreignSource = "Bogus FS";
        final String location = LOCATION;

        // Create the config aka job
        Specific specific = new Specific();
        specific.setContent( ipAddress );

        DiscoveryConfiguration config = new DiscoveryConfiguration();
        config.addSpecific( specific );
        config.setForeignSource( foreignSource );
        config.setTimeout( 3000 );
        config.setRetries( 2 );
        config.setLocation( location );

        // Timeout should be 1 * 3000 * (2 + 1) * 1.5 = 13500ms

        // Execute the job
        try {
            template.requestBody( "direct:submitDiscoveryTask", config );
        } catch(CamelExecutionException e) {
            // Expected failure exception
            assertEquals(ExchangeTimedOutException.class, e.getCause().getClass());
            return;
        } finally {
            mockDiscoverer.stop();
        }
        fail("A timeout exception should be thrown from the exchange");
    }

