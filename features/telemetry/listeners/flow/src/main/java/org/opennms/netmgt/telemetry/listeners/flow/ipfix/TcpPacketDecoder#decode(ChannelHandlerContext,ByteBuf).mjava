    private Object decode(final ChannelHandlerContext ctx, final ByteBuf in) throws InvalidPacketException {
        in.markReaderIndex();

        if (in.readableBytes() < Header.SIZE) {
            in.resetReaderIndex();
            return null;
        }

        final ByteBuffer headerBuffer = in.readSlice(Header.SIZE).nioBuffer();
        final Header header = new Header(headerBuffer);

        if (in.readableBytes() < header.length - Header.SIZE) {
            in.resetReaderIndex();
            return null;
        }

        final ByteBuffer payloadBuffer = in.readSlice(header.length - Header.SIZE).nioBuffer();
        final Packet packet = new Packet(this.templateManager, this.senderAddress, header, payloadBuffer);

        return new DefaultAddressedEnvelope<>(packet, this.recipientAddress, this.senderAddress);
    }

