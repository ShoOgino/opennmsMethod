    protected ScriptedCollectionSetBuilder getCollectionBuilder() throws Exception {

        ScriptedCollectionSetBuilder builder = scriptedCollectionSetBuilders.get();
        if ((builder != null && scriptMap.get(builder)) || !scriptCompiled.get()) {
            scriptedCollectionSetBuilders.remove();
            builder = scriptedCollectionSetBuilders.get();
        }
        if (builder == null) {
            scriptCompiled.set(false);
            throw new Exception(String.format("Error compiling script '%s'. See logs for details.", script));
        } else if (!scriptCompiled.get()) {
            scriptCompiled.set(true);
        }
        return builder;
    }

