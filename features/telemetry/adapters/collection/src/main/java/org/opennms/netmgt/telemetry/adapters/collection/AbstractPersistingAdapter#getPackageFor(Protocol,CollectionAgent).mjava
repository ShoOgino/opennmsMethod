    private Package getPackageFor(Protocol protocol, CollectionAgent agent) {
        for (Package pkg : protocol.getPackages()) {
            final String filterRule = pkg.getFilterRule();
            if (filterRule == null) {
                // No filter specified, always match
                return pkg;
            }
            // TODO: This is really inefficient, since it actually retrieves *all*
            // IP addresses that match the filter, and then checks of the given address
            // is in the set. See HZN-1161.
            // NOTE: The location of the host address is not taken into account.
            if (filterDao.isValid(agent.getHostAddress(), filterRule)) {
                return pkg;
            }
        }
        return null;
    }

