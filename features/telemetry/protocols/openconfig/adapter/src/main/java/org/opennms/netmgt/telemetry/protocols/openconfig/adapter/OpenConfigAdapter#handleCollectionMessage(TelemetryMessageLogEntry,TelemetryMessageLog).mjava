    @Override
    public Stream<CollectionSetWithAgent> handleCollectionMessage(TelemetryMessageLogEntry message, TelemetryMessageLog messageLog) {

        try {
            // Default mode is gnmi
            if (JTI_MODE.equalsIgnoreCase(mode)) {
                Telemetry.OpenConfigData openConfigData = Telemetry.OpenConfigData.parseFrom(message.getByteArray());
                String systemId = openConfigData.getSystemId();
                CollectionAgent agent = getCollectionAgent(messageLog, systemId);
                return buildCollectionSet(agent, openConfigData, openConfigData.getTimestamp());
            } else {
                Gnmi.SubscribeResponse subscribeResponse = Gnmi.SubscribeResponse.parseFrom(message.getByteArray());
                Gnmi.Notification notification = subscribeResponse.getUpdate();
                long timeStamp = notification != null ? notification.getTimestamp() : message.getTimestamp();
                CollectionAgent agent = getCollectionAgent(messageLog, null);
                return buildCollectionSet(agent, subscribeResponse, timeStamp);

            }
        } catch (InvalidProtocolBufferException e) {
            LOG.warn("Invalid packet: {}", e);
            return Stream.empty();
        }

    }

