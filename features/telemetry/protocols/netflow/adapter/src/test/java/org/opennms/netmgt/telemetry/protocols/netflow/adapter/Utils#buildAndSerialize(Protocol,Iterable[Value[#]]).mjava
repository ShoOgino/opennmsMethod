    public static FlowMessage.Builder buildAndSerialize(Protocol protocol, Iterable<Value<?>> record) throws IllegalFlowException {
        RecordEnrichment enrichment = (address -> Optional.empty());
        if (protocol.equals(Protocol.NETFLOW5)) {
            Netflow5MessageBuilder builder = new Netflow5MessageBuilder();
            return builder.buildMessage(record, enrichment);
        } else if (protocol.equals(Protocol.NETFLOW9)) {
            Netflow9MessageBuilder builder = new Netflow9MessageBuilder();
            return builder.buildMessage(record, enrichment);
        } else if (protocol.equals(Protocol.IPFIX)) {
            IpFixMessageBuilder builder = new IpFixMessageBuilder();
            return builder.buildMessage(record, enrichment);
        }
        return null;
    }

