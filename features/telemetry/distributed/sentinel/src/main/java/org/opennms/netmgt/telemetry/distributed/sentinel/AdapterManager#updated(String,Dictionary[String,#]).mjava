    @Override
    public void updated(String pid, Dictionary<String, ?> properties) {
        final TelemetryMessageConsumer existingConsumer = consumersById.get(pid);
        if (existingConsumer != null) {
            LOG.info("Updating existing consumer for pid: {}", pid);
            deleted(pid);
        } else {
            LOG.info("Creating new consumer for pid: {}", pid);
        }

        // Convert the dictionary to a map
        final Map<String, String> parameters = MapUtils.fromDict(properties);

        // Build the protocol and listener definitions
        final Protocol protocolDef = new MapBasedProtocolDef(parameters);
        final Adapter adapterDef = new MapBasedAdapterDef(parameters);

        // Register health check
        final AdapterHealthCheck healthCheck = new AdapterHealthCheck(adapterDef);
        final ServiceRegistration<HealthCheck> serviceRegistration = bundleContext.registerService(HealthCheck.class, healthCheck, null);
        healthChecksById.put(pid, serviceRegistration);

        try {
            // Create the Module
            final TelemetrySinkModule sinkModule = new TelemetrySinkModule(protocolDef);
            sinkModule.setDistPollerDao(distPollerDao);

            // Create the consumer
            final TelemetryMessageConsumer consumer = new TelemetryMessageConsumer(protocolDef, Lists.newArrayList(adapterDef), sinkModule);
            consumer.setAdapterRegistry(telemetryAdapterRegistry);
            consumer.init();
            messageConsumerManager.registerConsumer(consumer);
            consumersById.put(pid, consumer);

            // At this point the consumer should be up and running, so we mark the underlying health check as success
            healthCheck.setSuccess();
        } catch (Exception e) {
            // In case of error, we mark the health check as failure as well
            healthCheck.setError(e);
            LOG.error("Failed to create {}", TelemetryMessageConsumer.class, e);
        }
    }

