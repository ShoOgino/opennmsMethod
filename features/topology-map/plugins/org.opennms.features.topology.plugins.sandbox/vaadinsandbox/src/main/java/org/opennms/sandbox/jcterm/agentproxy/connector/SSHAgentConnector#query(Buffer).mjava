  public void query(Buffer buffer) throws AgentProxyException {
    USocketFactory.Socket sock = null;
    try {
      sock = open();
      sock.write(buffer.buffer, 0, buffer.getLength());
      buffer.rewind();
      int i = sock.readFull(buffer.buffer, 0, 4);  // length
      i = buffer.getInt();
      buffer.rewind();
      buffer.checkFreeSize(i);
      i = sock.readFull(buffer.buffer, 0, i);
    }
    catch(IOException e){
      throw new AgentProxyException(e.toString());
    }
    finally {
      try {
        if(sock!=null)
          sock.close();
      }
      catch(IOException e){
        throw new AgentProxyException(e.toString());
      }
    }
  }

