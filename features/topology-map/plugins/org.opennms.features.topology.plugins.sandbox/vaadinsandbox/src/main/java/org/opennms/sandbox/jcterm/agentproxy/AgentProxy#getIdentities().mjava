  public synchronized Identity[] getIdentities() {
    Identity[] identities = null;

    byte code1 = SSH2_AGENTC_REQUEST_IDENTITIES;
    byte code2 = SSH2_AGENT_IDENTITIES_ANSWER;

    buffer.reset();
    buffer.putByte(code1);
    buffer.insertLength();

    try {
      connector.query(buffer);
    }
    catch(AgentProxyException e){
      buffer.rewind();
      buffer.putByte(SSH_AGENT_FAILURE);
      identities = new Identity[0];
      return identities;
    }

    int rcode = buffer.getByte();

    check_reply(rcode);
//System.out.println(rcode == code2);

    int count = buffer.getInt();

//System.out.println(count);

    identities = new Identity[count];

    for(int i=0; i<identities.length; i++){
      identities[i] = new Identity(buffer.getString(), buffer.getString());
    }

    return identities;
  }

