  private int sendWRITE(byte[] handle, long offset, 
                        byte[] data, int start, int length) throws Exception{
    int _length=length;
    opacket.reset();
    if(obuf.buffer.length<obuf.index+13+21+handle.length+length+Session.buffer_margin){
      _length=obuf.buffer.length-(obuf.index+13+21+handle.length+Session.buffer_margin);
      // System.err.println("_length="+_length+" length="+length);
    }

    putHEAD(obuf, SSH_FXP_WRITE, 21+handle.length+_length);       // 14
    obuf.putInt(seq++);                                      //  4
    obuf.putString(handle);                                  //  4+handle.length
    obuf.putLong(offset);                                    //  8
    if(obuf.buffer!=data){
      obuf.putString(data, start, _length);                    //  4+_length
    }
    else{
      obuf.putInt(_length);
      obuf.skip(_length);
    }
    getSession().write(opacket, this, 21+handle.length+_length+4);
    return _length;
  }

