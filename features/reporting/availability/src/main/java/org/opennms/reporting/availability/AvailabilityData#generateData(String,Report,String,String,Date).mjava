    private void generateData(String categoryName, Report report,
            String format, String monthFormat,
            Date periodEndDate)
            throws IOException, MarshalException, ValidationException,
            Exception {
        ThreadCategory.setPrefix(LOG4J_CATEGORY);
        ThreadCategory log = ThreadCategory.getInstance(this.getClass());
        log.debug("Inside AvailabilityData");

        m_nodes = new ArrayList<Node>();
        
        initializeInterval(periodEndDate);

        Catinfo config = null;
        try {
            CategoryFactory.init();
            m_catFactory = CategoryFactory.getInstance();
            config = m_catFactory.getConfig();
        } catch (IOException e) {
            log.fatal("Initializing CategoryFactory", e);
            throw e;
        } catch (MarshalException e) {
            log.fatal("Initializing CategoryFactory", e);
            throw e;
        } catch (ValidationException e) {
            log.fatal("Initializing CategoryFactory", e);
            throw e;
        }
        
        // FIXME There's some magic in here regarding multiple categories in a report

        if (log.isDebugEnabled()) {
            log.debug("CATEGORY " + categoryName);
        }
        
        m_catFactory.getReadLock().lock();
        try {
            if (categoryName.equals("") || categoryName.equals("all")) {
                int catCount = 0;
                if (log.isDebugEnabled()) {
                    log.debug("catCount " + catCount);
                }
                
                for(final Categorygroup cg : config.getCategorygroupCollection()) {
                
                    for(org.opennms.netmgt.config.categories.Category cat : cg.getCategories().getCategoryCollection()) {
    
                        if (log.isDebugEnabled()) {
                            log.debug("CATEGORY " + cat.getLabel());
                        }
                        catCount++;
                        populateDataStructures(cat, report, format, monthFormat, catCount);
                    }
                }
                if (log.isDebugEnabled()) {
                    log.debug("catCount " + catCount);
                }
            } else {
                org.opennms.netmgt.config.categories.Category cat = (org.opennms.netmgt.config.categories.Category) m_catFactory.getCategory(categoryName);
                if (log.isDebugEnabled()) {
                    log.debug("CATEGORY - now populating data structures "
                            + cat.getLabel());
                }
                populateDataStructures(cat, report, format, monthFormat, 1);
            }
    
            final SimpleDateFormat simplePeriod = new SimpleDateFormat("MMMMMMMMMMM dd, yyyy");
            final String reportPeriod = simplePeriod.format(new java.util.Date(m_startTime)) + " - " + simplePeriod.format(new java.util.Date(m_endTime));
            Created created = report.getCreated();
            if (created == null) {
                created = new Created();
            }
            created.setPeriod(reportPeriod);
            report.setCreated(created);
        } finally {
            m_catFactory.getReadLock().unlock();
        }

        if (log.isDebugEnabled()) {
            log.debug("After availCalculations");
        }
    }

