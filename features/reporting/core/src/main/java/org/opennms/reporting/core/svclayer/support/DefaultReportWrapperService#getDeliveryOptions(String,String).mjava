    /** {@inheritDoc} */
    @Override
    public DeliveryOptions getDeliveryOptions(String reportId, String userId) {
        DeliveryOptions options = new DeliveryOptions();

        options.setFormat(ReportFormat.HTML);
        options.setPersist(true);
        options.setSendMail(false);

        UserManager userFactory = UserFactory.getInstance();

        try {
            String emailAddress = userFactory.getEmail(userId);
            if (emailAddress != null) {
                options.setMailTo(emailAddress);
            }
        } catch (MarshalException e) {
            LOG.error("marshal exception trying to set destination email address", e);
        } catch (ValidationException e) {
            LOG.error("validation exception trying to set destination email address", e);
        } catch (IOException e) {
            LOG.error("IO exception trying to set destination email address", e);
        } catch (NullPointerException e) { // See NMS-5111 for more details.
            LOG.warn("the user {} does not have any email configured.", userId);
        }

        options.setInstanceId(reportId + " " + userId);

        return options;
    }

