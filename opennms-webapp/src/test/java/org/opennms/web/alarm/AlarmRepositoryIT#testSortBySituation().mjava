    @Test
    @Transactional
    @JUnitTemporaryDatabase
    public void testSortBySituation() {
        OnmsDistPoller poller = m_dbPopulator.getDistPollerDao().whoami();

        final OnmsEvent event = new OnmsEvent();
        event.setEventLog("Y");
        event.setEventDisplay("Y");
        event.setEventCreateTime(new Date());
        event.setDistPoller(poller);
        event.setEventTime(new Date());
        event.setEventSeverity(OnmsSeverity.CRITICAL.getId());
        event.setEventUei("uei://org/opennms/test/EventDaoTest");
        event.setEventSource("test");
        m_dbPopulator.getEventDao().save(event);
        m_dbPopulator.getEventDao().flush();

        final OnmsNode node = m_dbPopulator.getNodeDao().findAll().iterator().next();

        final OnmsAlarm alarm1 = new OnmsAlarm();
        alarm1.setNode(node);
        alarm1.setUei(event.getEventUei());
        alarm1.setSeverityId(event.getEventSeverity());
        alarm1.setFirstEventTime(event.getEventTime());
        alarm1.setLastEvent(event);
        alarm1.setCounter(1);
        alarm1.setDistPoller(poller);
        m_dbPopulator.getAlarmDao().save(alarm1);
        m_dbPopulator.getAlarmDao().flush();

        final OnmsAlarm alarm2 = new OnmsAlarm();
        alarm2.setNode(node);
        alarm2.setUei(event.getEventUei());
        alarm2.setSeverityId(event.getEventSeverity());
        alarm2.setFirstEventTime(event.getEventTime());
        alarm2.setLastEvent(event);
        alarm2.setCounter(1);
        alarm2.setDistPoller(poller);
        alarm2.setRelatedAlarms(Sets.newHashSet(alarm1));
        m_dbPopulator.getAlarmDao().save(alarm2);
        m_dbPopulator.getAlarmDao().flush();

        assertEquals(3, m_dbPopulator.getAlarmDao().findAll().size());

        final AlarmCriteria sortedAsc = new AlarmCriteria(new Filter[0], SortStyle.SITUATION, AcknowledgeType.UNACKNOWLEDGED, 100, 0);
        final OnmsAlarm[] alarmsAsc = m_alarmRepo.getMatchingAlarms(AlarmUtil.getOnmsCriteria(sortedAsc));

        final AlarmCriteria sortedDesc = new AlarmCriteria(new Filter[0], SortStyle.REVERSE_SITUATION, AcknowledgeType.UNACKNOWLEDGED, 100, 0);
        final OnmsAlarm[] alarmsDesc = m_alarmRepo.getMatchingAlarms(AlarmUtil.getOnmsCriteria(sortedDesc));

        assertEquals(3, alarmsAsc.length);
        assertEquals(true, alarmsAsc[0].isSituation());
        assertEquals(false, alarmsAsc[1].isSituation());
        assertEquals(false, alarmsAsc[2].isSituation());
        assertEquals(3, alarmsDesc.length);
        assertEquals(false, alarmsDesc[0].isSituation());
        assertEquals(false, alarmsDesc[1].isSituation());
        assertEquals(true, alarmsDesc[2].isSituation());
    }

