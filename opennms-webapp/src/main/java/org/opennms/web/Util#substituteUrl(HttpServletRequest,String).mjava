    protected static String substituteUrl(HttpServletRequest request,
                                          String tmpl) {
        String[] replacements = {
            request.getScheme(),                        // %s
            request.getServerName(),                    // %h
            Integer.toString(request.getServerPort()),  // %p
            getHostHeader(request),                     // %x
            request.getContextPath()                    // %c
        };

        StringBuffer out = new StringBuffer(48);
        for (int i = 0; i < tmpl.length();) {
            char c = tmpl.charAt(i++);
            if (c == '%' && i < tmpl.length()) {
                char d = tmpl.charAt(i++);
                for (int key = 0; key < substKeywords.length; ++key) {
                    if (d == substKeywords[key]) {
                        out.append(replacements[key]);
                        break;
                    }
                }
            }
            else {
                out.append(c);
            }
        }
        return out.toString();
    }

