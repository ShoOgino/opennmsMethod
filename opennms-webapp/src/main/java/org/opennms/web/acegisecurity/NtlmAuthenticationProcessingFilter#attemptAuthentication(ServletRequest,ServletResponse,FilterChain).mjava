        /**
         * This method simply calls <tt>negotiate( req, resp, false )</tt>
         * and then <tt>chain.doFilter</tt>. You can override and call
         * negotiate manually to achive a variety of different behavior.
         */
        public Authentication attemptAuthentication( ServletRequest request,
                    ServletResponse response,
                    FilterChain chain ) throws IOException, ServletException,AuthenticationException {
        	if (!initialized) {
        		init(null);
        	}

        	HttpServletRequest req = (HttpServletRequest)request;
            HttpServletResponse resp = (HttpServletResponse)response;
            NtlmPasswordAuthentication ntlm;

            log().info("initializing negotiation");
            if ((ntlm = negotiate( req, resp, false )) == null) {
                log().info("ntlm negotiation ended with failure");
                throw new BadCredentialsException("NTLM authentication failed");
            }

            //GrantedAuthorityImpl[] gas = {new GrantedAuthorityImpl("ROLE_USER"),new GrantedAuthorityImpl("ROLE_ADMIN")};
            log().debug("ntlm username: " + ntlm.getUsername());
            
            LdapUserDetails userFromSearch = getUserSearch().searchForUser(ntlm.getUsername());
            log().debug("User Detail Found Dn: " + userFromSearch.getDn());

            GrantedAuthority[] gas = ldapAuthoritiesPopulator.getGrantedAuthorities(userFromSearch);


            UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(ntlm.getUsername(),"",gas);
            
            log().debug("authentication credentials: " + auth.getCredentials());
            

            // Authentication success
            // Place the last username attempted into HttpSession for views
            req.getSession().setAttribute(org.acegisecurity.ui.webapp.AuthenticationProcessingFilter.ACEGI_SECURITY_LAST_USERNAME_KEY, ntlm.getUsername());

            // Allow subclasses to set the "details" property
            setDetails(req, auth);
            return auth;
        }

