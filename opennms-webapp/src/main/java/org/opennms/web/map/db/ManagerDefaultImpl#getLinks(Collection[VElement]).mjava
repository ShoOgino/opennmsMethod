    private List<VLink> getLinks(Collection<VElement> elems) throws MapsException {
        if (elems == null)
            return null;
        String multilinkStatus = mapsPropertiesFactory.getMultilinkStatus();
        List<VLink> links = new ArrayList<VLink>();
        Map<String,List<VLink>> singlevlinkmap = new HashMap<String,List<VLink>>();
        Map<String,VLink> multivlinkmap = new HashMap<String,VLink>();
        Map<String,Integer> numberofsinglelinksmap = new HashMap<String,Integer>();

        java.util.Map<Integer, Set<VElement>> node2Element = new HashMap<Integer, Set<VElement>>();

        HashSet<Integer> allNodes = new HashSet<Integer>();

        for (VElement ve : elems) {
            for (Integer nodeid : getNodeidsOnElement(ve)) {
                allNodes.add(nodeid);
                Set<VElement> elements = node2Element.get(nodeid);
                if (elements == null) {
                    elements = new java.util.HashSet<VElement>();
                }
                elements.add(ve);
                node2Element.put(nodeid, elements);
            }
        }

        for (LinkInfo linfo : dbManager.getLinksOnElements(allNodes)) {
            log.debug("Found link: node1:" + linfo.nodeid + " node2: "
                    + linfo.nodeparentid);
            log.debug("Getting linkinfo for nodeid " + linfo.nodeid);
            
            for (VElement first : node2Element.get(linfo.nodeid)) {
                log.debug("Getting linkinfo for nodeid " + linfo.nodeparentid);
                for (VElement second : node2Element.get(linfo.nodeparentid)) {
                    if (first.hasSameIdentifier(second)) {
                        continue;
                    }
                    
                    int status=getLinkStatus(linfo);
                    String statusString = getLinkStatusString(status);
 
                    VLink vlink = new VLink(first.getId(), first.getType(),
                                            second.getId(), second.getType(), getLinkTypeId(linfo));
                    vlink.setLinkStatusString(statusString);
                    vlink.increaseStatusMapLinks(statusString);
                    Set<Integer> nodeids=vlink.getNodeids();
                    nodeids.add(linfo.nodeid);
                    nodeids.add(linfo.nodeparentid);
                    vlink.setNodeids(nodeids);
                    log.debug("adding new link as single link: " + vlink.toString());
                    
                    List<VLink> templinks=null;
                    if (singlevlinkmap.containsKey(vlink.getId())) {
                        templinks=singlevlinkmap.get(vlink.getId());
                    } else {
                        templinks = new ArrayList<VLink>();
                    }
                    templinks.add(vlink);
                    singlevlinkmap.put(vlink.getId(), templinks);
                    
                    int numberofelement=1;
                    if (numberofsinglelinksmap.containsKey(vlink.getIdWithoutLinkType())) {
                        numberofelement = numberofsinglelinksmap.get(vlink.getIdWithoutLinkType());
                        numberofelement++;
                    }
                    numberofsinglelinksmap.put(vlink.getIdWithoutLinkType(), numberofelement);
                    log.debug("updated link counter between elements: " + vlink.getIdWithoutLinkType() + " Found #" + numberofelement);


                    VLink vmultilink = new VLink(first.getId(), first.getType(),
                                                 second.getId(), second.getType(), getLinkTypeId(linfo));
                    vmultilink.setLinkStatusString(statusString);
                    vmultilink.increaseStatusMapLinks(statusString);
                    if (multivlinkmap.containsKey(vmultilink.getId())) {
                        VLink alreadyIn = multivlinkmap.get(vmultilink.getId());
                        int numberOfLinks = alreadyIn.increaseLinks();
                        log.debug("Updated " + numberOfLinks + " on Link: " + alreadyIn.getId());
                        int numberOfLinkwithStatus = alreadyIn.increaseStatusMapLinks(statusString);
                        log.debug("Updated Status Map: found: "+ numberOfLinkwithStatus + " links with Status: " +statusString );
                        if ( ( multilinkStatus.equals(MapPropertiesFactory.MULTILINK_BEST_STATUS) 
                               && status < getLinkStatusInt(alreadyIn.getLinkStatusString())
                             ) 
                          || ( multilinkStatus.equals(MapPropertiesFactory.MULTILINK_WORST_STATUS) 
                               && status > getLinkStatusInt(alreadyIn.getLinkStatusString())
                             )
                            ) {
                            log.debug("Upgrading with Link info becouse multilink.status=" + multilinkStatus);
                            log.debug("updating existing the link "
                                  + alreadyIn.toString()
                                  + " with status "
                                  + alreadyIn.getLinkStatusString());

                            log.debug("setting link properties: "
                                  + vmultilink.toString()
                                  + " with new found status "
                                  + vmultilink.getLinkStatusString());
                            alreadyIn.setLinkStatusString(statusString);
                        }
                        nodeids=alreadyIn.getNodeids();
                        nodeids.add(linfo.nodeid);
                        nodeids.add(linfo.nodeparentid);
                        alreadyIn.setNodeids(nodeids);
                        log.debug("updating multi link: " + alreadyIn.toString());
                        multivlinkmap.put(alreadyIn.getId(),alreadyIn);
                    } else {
                        Set<Integer> vmnodeids=vmultilink.getNodeids();
                        vmnodeids.add(linfo.nodeid);
                        vmnodeids.add(linfo.nodeparentid);
                        vmultilink.setNodeids(vmnodeids);
                        log.debug("adding multi link: " + vmultilink.toString());
                        multivlinkmap.put(vmultilink.getId(),vmultilink);
                    }
                } // end second element for
            } //end first element for
        } // end linkinfo for
        // Now add the VLink to links......
        int maxlinks=mapsPropertiesFactory.getMaxLinks();
        for (String elid : numberofsinglelinksmap.keySet()) {
            log.debug("parsing link between element: " + elid + " with #links " + numberofsinglelinksmap.get(elid));
            if (numberofsinglelinksmap.get(elid) <= maxlinks) {
                for (String linkid : singlevlinkmap.keySet()) {
                    if (linkid.indexOf(elid) != -1) {
                        log.debug("adding single links for " + linkid + " Adding links # " + singlevlinkmap.get(linkid).size());
                        links.addAll(singlevlinkmap.get(linkid));
                    }
                }
            } else {
                for (String linkid : multivlinkmap.keySet()) {
                    if (linkid.indexOf(elid) != -1) { 
                        log.debug("adding multi link for : " + linkid);
                        links.add(multivlinkmap.get(linkid));
                    }
                }
                
            }
        }
        log.debug("Found links #" + links.size());
        for (VLink vlink : links) {
            log.debug(vlink.toString());
        }
        return links;
    }

