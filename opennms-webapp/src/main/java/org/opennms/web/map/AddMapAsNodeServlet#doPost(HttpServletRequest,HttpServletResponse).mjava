    public void doPost( HttpServletRequest request, HttpServletResponse response ) throws ServletException, IOException 
    {
      ThreadCategory.setPrefix(LOG4J_CATEGORY);
      log = ThreadCategory.getInstance(this.getClass());
      BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(response.getOutputStream()));
        
      int mapId = Integer.parseInt(request.getParameter("MapId"));
      int parentMapId = Integer.parseInt(request.getParameter("parentMapId"));
      
      
      //build a map in wich each entry is [mapparentid, listofchildsids]
      log.info("building parent-childs Map...");
      maps = new HashMap();
      String SQL_PARENT_CHILD_MAP_QUERY = "select elementid,mapid from element where elementtype=?";
      try{
          	Connection connection = Vault.getDbConnection();
          	PreparedStatement ps = connection.prepareStatement(SQL_PARENT_CHILD_MAP_QUERY);
          	ps.setString(1,Element.MAP_TYPE);
          	ResultSet rs = ps.executeQuery();
          	while(rs.next()){
          		Integer parentId = new Integer(rs.getInt("mapid"));
          		Integer childId = new Integer(rs.getInt("elementid"));
          		List childs  = (List)maps.get(parentId);
          		if(childs==null){
          			childs=new ArrayList();
          		}
          		if(!childs.contains(childId)){
          			childs.add(childId);
          		}
          		maps.put(parentId,childs);
          	}
      }catch(SQLException se){
      	   	throw new ServletException(se);
      }
      Iterator it = maps.entrySet().iterator();
      while(it.hasNext()){
      	Map.Entry entry = (Map.Entry)it.next();
      	log.info("parent:"+(Integer)entry.getKey());
      	log.info("childs of "+(Integer)entry.getKey()+":"+(ArrayList)entry.getValue());
      }
      log.info("searching for loops...");
     // List parentList = new ArrayList();
     // preorderVisit(new Integer(parentMapId), parentList);
      
      List childList = new ArrayList();
      preorderVisit(new Integer(mapId), childList);
      for(int i=0; i<childList.size(); i++){
      	preorderVisit((Integer)childList.get(i), childList);
      }
      
      //log.info("parentvisit="+parentList);
      log.info("childvisit = "+childList);
      
      String strToSend="addMapAsNodeOK";
     try{
	    // boolean found = compareVisits(parentList, childList);

     	 if(childList.contains(new Integer(parentMapId))){
	       	log.info("loop found!");
	      	strToSend="LoopFound";
	      }else{
		      log.info("Fetching Map with id="+mapId);
		      try{
		      	SimpleDateFormat formatter = new SimpleDateFormat("HH.mm.ss dd/MM/yy");		
		      	
		      	Manager m = new Manager();
		      	VMap map = m.getMap(mapId);
		      	String createTime = "";
		      	if(map.getCreateTime()!=null)
		      		createTime =formatter.format(map.getCreateTime());
		      	String lastModTime = "";
		      	if(map.getLastModifiedTime()!=null)
		      		lastModTime =formatter.format(map.getLastModifiedTime());
		      	strToSend+=map.getId()+"+"+map.getName();
		      	VElement[] elems = map.getAllElements();
		      	if(elems!=null){
			      	for(int i=0;i<elems.length;i++){
			      		strToSend+="&"+elems[i].getId()+"&"+elems[i].getType();
			      	}
			    }
		      }catch(Exception e){
		      	log.error("Map open error: "+e);
		      	throw new ServletException(e);
		      }
	      }
	      bw.write(strToSend);
	      bw.close();
	      log.info("Sending response to the client '"+strToSend+"'");
     }catch(Exception e){
     	throw new ServletException(e);
     }
    }

