    private InputStream getGraphStream(HttpServletRequest request) throws IOException, RrdException {
        Object o = request.getSession().getAttribute("graphDef");

        
        if (m_renderer == null) {
            throw new IllegalStateException("graph renderer has not been set with setGraphRenderer");
        }
        if (o == null) {
            throw new IllegalStateException("session has no \"graphDef\" attribute, or it is null");
        }
        if (!(o instanceof GraphDefinition)) {
            throw new IllegalStateException("\"graphDef\" session attribute is not an instance of " +
                    GraphDefinition.class.getName());
        }
        
        GraphDefinition graphDef = (GraphDefinition) o;
        
        InputStream graphStream = m_renderer.getPNG(graphDef);
        return graphStream;
    }

