    public void migrate(Migration migration) throws MigrationException {
        Connection connection;
        Database database;

        SpringFileOpener sfo = new SpringFileOpener();
        sfo.setResourceLoader(getMigrationResourceLoader(migration));

        try {
            connection = m_dataSource.getConnection();
        } catch (Exception e) {
            throw new MigrationException("unable to get a database connection from the datasource", e);
        }

        try {
            database = DatabaseFactory.getInstance().findCorrectDatabaseImplementation(connection);
        } catch (Exception e) {
            cleanUpDatabase(connection, null, null);
            throw new MigrationException("unable to determine the Liquibase database object", e);
        }

        Liquibase liquibase = new Liquibase( migration.getChangeLog(), sfo, database );
        liquibase.setChangeLogParameterValue("install.database.admin.user", migration.getAdminUser());
        liquibase.setChangeLogParameterValue("install.database.admin.password", migration.getAdminPassword());
        liquibase.setChangeLogParameterValue("install.database.user", migration.getDatabaseUser());

        final String contexts = System.getProperty("opennms.contexts", "production");
        try {
            liquibase.update("");
        } catch (Exception e) {
            cleanUpDatabase(connection, null, null);
            throw new MigrationException("unable to update the database", e);
        }

        cleanUpDatabase(connection, null, null);
    }

