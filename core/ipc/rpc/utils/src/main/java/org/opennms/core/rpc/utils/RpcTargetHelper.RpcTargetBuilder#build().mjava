        public RpcTarget build() {
            // Start with the provided location
            String targetLocation = location;

            // Use the location set in the attributes, if any
            final String locationFromAttributes = getStringAttribute(LOCATION_KEY);
            if (locationFromAttributes != null) {
                targetLocation = locationFromAttributes;
            }

            // And finally, apply the override
            if (locationOverride != null) {
                final String locationFromOverride = locationOverride.apply(targetLocation);
                if (locationFromOverride != null) {
                    targetLocation = locationFromOverride;
                }
            }

            // Now start with the provided system id
            String targetSystemId = systemId;

            // Use the system-id set in the attributes, if any
            final String systemIdFromAttributes = getStringAttribute(SYSTEM_ID_KEY);
            if (systemIdFromAttributes != null) {
                targetSystemId = systemIdFromAttributes;
            }

            // Override using the foreign-id, if the flag is set, and we have
            // all of the necessary bits
            if (Boolean.TRUE.toString().equalsIgnoreCase(getStringAttribute(USE_FOREIGN_ID_AS_SYSTEM_ID_KEY))
                    && nodeId != null && nodeDao != null) {
                final OnmsNode node = nodeDao.get(nodeId);
                if (node != null && node.getForeignId() != null) {
                    targetSystemId = node.getForeignId();
                }
            }

            return new RpcTarget(targetLocation, targetSystemId);
        }

