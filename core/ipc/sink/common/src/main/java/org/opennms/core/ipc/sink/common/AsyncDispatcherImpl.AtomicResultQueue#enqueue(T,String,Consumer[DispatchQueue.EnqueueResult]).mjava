        void enqueue(T message, String key, Consumer<DispatchQueue.EnqueueResult> onEnqueue) throws WriteFailedException {
            CountDownLatch resultRecorded = new CountDownLatch(1);
            resultRecordedMap.put(key, resultRecorded);
            DispatchQueue.EnqueueResult result = dispatchQueue.enqueue(message, key);

            // When the result is DEFERRED we should not track the future so remove it from the map
            if (result == DispatchQueue.EnqueueResult.DEFERRED) {
                resultRecordedMap.remove(key);
            }

            onEnqueue.accept(result);
            resultRecorded.countDown();
        }

