    private void testNative(int family, InetAddress address) throws Exception {
        String[] cmds = new String[] { "nativeEcho", "nativeEcho2", "quitNative" };
        NativeDatagramSocket socket = null;

        try {
            socket = NativeDatagramSocket.create(family, NativeDatagramSocket.SOCK_DGRAM,
                    NativeDatagramSocket.IPPROTO_UDP);

            for(String cmd : cmds) {

                printf("Sending cmd: %s\n", cmd);
                
                ByteBuffer buf = UTF_8.encode(cmd);

                NativeDatagramPacket p = new NativeDatagramPacket(buf, address, 7777); 

                socket.send(p);

                NativeDatagramPacket r = new NativeDatagramPacket(128);
                socket.receive(r);
                
                String response = UTF_8.decode(r.getContent()).toString();

                printf("Received Response: %s from %s:%d\n", response, r.getAddress().getHostAddress(), r.getPort());

                assertEquals(cmd, response);
            }

        } finally {
            if (socket != null) socket.close();
        }
    }

