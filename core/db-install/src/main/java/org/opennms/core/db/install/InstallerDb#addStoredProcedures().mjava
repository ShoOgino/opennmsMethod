    /**
     * <p>addStoredProcedures</p>
     *
     * @throws java.lang.Exception if any.
     */
    public void addStoredProcedures() throws Exception {
        m_triggerDao.reset();

        Statement st = getConnection().createStatement();

        m_out.print("- adding stored procedures... ");

        File[] list = new File(m_storedProcedureDirectory).listFiles(m_sqlFilter);

        for (final File element : list) {
        	final LinkedList<String> drop = new LinkedList<String>();
            final StringBuffer create = new StringBuffer();
            String line;

            m_out.print("\n  - " + element.getName() + "... ");

            final BufferedReader r = new BufferedReader(new InputStreamReader(new FileInputStream(element), "UTF-8"));
            while ((line = r.readLine()) != null) {
                line = line.trim();

                if (line.matches("--.*")) {
                    continue;
                }

                if (line.toLowerCase().startsWith("drop function")
                    || line.toLowerCase().startsWith("drop trigger")) {
                    drop.add(line);
                } else {
                    create.append(line);
                    create.append("\n");
                }
            }
            r.close();
            
            /*
             * Find the trigger first, because if there is a trigger that
             * uses this stored procedure on this table, we'll need to drop
             * it first.
             */
            final Trigger t = Trigger.findTriggerInString(create.toString());
            if (t != null) {
                m_triggerDao.add(t);
            }

            final Matcher m = m_createFunction.matcher(create.toString());

            if (!m.find()) {
                throw new Exception("For stored procedure in file '"
                                    + element.getName()
                                    + "' couldn't match \""
                                    + m.pattern().pattern()
                                    + "\" in string \"" + create + "\"");
            }
            final String createSql = m.group(1);
            final String function = m.group(2);
            final String columns = m.group(3);
            final String returns = m.group(4);
            // final String rest = m.group(5);

            try {
                if (functionExists(function, columns, returns)) {
                    if (t != null && t.isOnDatabase(getConnection())) {
                        t.removeFromDatabase(getConnection());
                        
                    }
                    st.execute("DROP FUNCTION " + function + " (" + columns + ")");
                    st.execute(createSql);
                    m_out.print("OK (dropped and re-added)");
                } else {
                    st.execute(createSql);
                    m_out.print("OK");
                }
            } catch (SQLException e) {
                throw new IllegalStateException("Could not add function: " + function, e);
            }
        }
        m_out.println("");
    }

