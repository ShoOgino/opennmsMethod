    /**
     * Send the SNMP PDU to the remote agent and invokes the specified handler
     * when the packet is recieve. This is a non-blocking call.
     * 
     * @param pdu
     *            The pdu to encode and send
     * @param handler
     *            The handler object for this request
     * 
     * @return The request identifier for the newly sent PDU.
     * 
     * @exception SnmpHandlerNotDefinedException
     *                Thrown if the handler is null
     * @exception java.lang.IllegalStateException
     *                Thrown if the session has been closed.
     */
    public int send(SnmpPduPacket pdu, SnmpHandler handler) {
        if (handler == null)
            throw new SnmpHandlerNotDefinedException("No Handler Defined");

        //
        // check to ensure that the session is still open
        //
        synchronized (m_sync) {
            if (m_stopRun) // session has been closed!
                throw new IllegalStateException("illegal operation, the session has been closed");
        }

        SnmpRequest req = new SnmpRequest(this, pdu, handler);
        if (pdu.getCommand() != SnmpPduPacket.V2TRAP || pdu.getPeer() == null) // traps
                                                                                // and
                                                                                // responses
                                                                                // don't
                                                                                // get
                                                                                // answers!
            addRequest(req);

        req.run();
        if (req.m_expired == true) {
            return 0;
        }

        return ((SnmpPduPacket) req.m_pdu).getRequestId();
    }

