    public Snmp createSnmpSession() throws IOException {
        TransportMapping<?> transport = new DefaultUdpTransportMapping();
        Snmp session = new Snmp(transport);
        
        if (isSnmpV3()) {
            // Make a new USM
            USM usm = new USM(SecurityProtocols.getInstance(), new OctetString(MPv3.createLocalEngineID()), 0);
            // Add the specified user to the USM
            usm.addUser(
                getSecurityName(),
                new UsmUser(
                    getSecurityName(),
                    getAuthProtocol(),
                    getAuthPassPhrase(),
                    getPrivProtocol(),
                    getPrivPassPhrase()
                )
            );
            // Remove the old SNMPv3 MessageProcessingModel. If you don't do this, you'll end up with
            // two SNMPv3 MessageProcessingModel instances in the dispatcher and connections will fail.
            MessageProcessingModel oldModel = session.getMessageDispatcher().getMessageProcessingModel(MessageProcessingModel.MPv3);
            if (oldModel != null) {
                session.getMessageDispatcher().removeMessageProcessingModel(oldModel);
            }
            // Add a new SNMPv3 MessageProcessingModel with the newly-created USM
            session.getMessageDispatcher().addMessageProcessingModel(new MPv3(usm));
        }
        
        return session;
    }

