    /**
     * Sends and SNMP4J request pdu.  The attributes in SnmpAgentConfig should have been
     * adapted from default SnmpAgentConfig values to those compatible with the SNMP4J library.
     * 
     * @param agentConfig
     * @param pduType TODO
     * @param oids
     * @param values can be null
     * @return
     */
    protected SnmpValue[] send(Snmp4JAgentConfig agentConfig, PDU pdu, boolean expectResponse) {
        Snmp session;

        try {
            session = agentConfig.createSnmpSession();
        } catch (IOException e) {
            s_log.error("send: Could not create SNMP session for agent {} : {}", agentConfig, e, e);
            return new SnmpValue[] { null };
        }

        try {
            if (expectResponse) {
                try {
                    session.listen();
                } catch (IOException e) {
                    s_log.error("send: error setting up listener for SNMP responses: {}", e, e);
                    return new SnmpValue[] { null };
                }
            }
    
            try {
                ResponseEvent responseEvent = session.send(pdu, agentConfig.getTarget());

                if (expectResponse) {
                    return processResponse(agentConfig, responseEvent);
                } else {
                    return null;
                }
            } catch (IOException e) {
                s_log.error("send: error during SNMP operation: " + e, e);
                return new SnmpValue[] { null };
            } catch (Throwable e) {
                s_log.error("send: unexpected error during SNMP operation: " + e, e);
                return new SnmpValue[] { null };
            }
        } finally {
            closeQuietly(session);
        }
    }

