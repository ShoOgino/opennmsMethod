    /**
     * Sends and SNMP4J request PDU.  The attributes in SnmpAgentConfig should have been
     * adapted from default SnmpAgentConfig values to those compatible with the SNMP4J library.
     */
    protected SnmpValue[] send(Snmp4JAgentConfig agentConfig, PDU pdu, boolean expectResponse) {
        Snmp session;

        try {
            session = agentConfig.createSnmpSession();
        } catch (IOException e) {
            LOG.error("send: Could not create SNMP session for agent {}", agentConfig, e);
            return new SnmpValue[] { null };
        }

        try {
            if (expectResponse) {
                try {
                    session.listen();
                } catch (IOException e) {
                    LOG.error("send: error setting up listener for SNMP responses", e);
                    return new SnmpValue[] { null };
                }
            }
    
            try {
                final ResponseEvent responseEvent = session.send(pdu, agentConfig.getTarget());

                if (expectResponse) {
                    return processResponse(agentConfig, responseEvent);
                } else {
                    return null;
                }
            } catch (final IOException e) {
                LOG.error("send: error during SNMP operation", e);
                return new SnmpValue[] { null };
            } catch (final RuntimeException e) {
                LOG.error("send: unexpected error during SNMP operation", e);
                return new SnmpValue[] { null };
            }
        } finally {
            closeQuietly(session);
        }
    }

