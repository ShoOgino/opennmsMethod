    public JMXServiceURL createJmxServiceURL() throws MalformedURLException {
        // For backwards compatibility keep old behaviour for now
        if (isLegacyConnection()) {
            if(isRemote()) {
                final String url = String.format("service:jmx:%s:%s:%s://jndi/%s://%s:%s%s",
                        getProtocol(),
                        InetAddressUtils.toUrlIpAddress(ipAddress),
                        getRmiServerPort(),
                        getProtocol(),
                        InetAddressUtils.toUrlIpAddress(ipAddress),
                        getPort(),
                        getUrlPath());
                return new JMXServiceURL(url);
            } else {
                final String url = String.format("service:jmx:%s:///jndi/%s://%s:%s%s",
                        getProtocol(),
                        getProtocol(),
                        InetAddressUtils.toUrlIpAddress(ipAddress),
                        getPort(),
                        getUrlPath());
                return new JMXServiceURL(url);
            }
        } else {
            // Create map to substitute url
            final Map<String, Object> propertiesMap = new HashMap<>();
            propertiesMap.put("ipaddr", InetAddressUtils.str(ipAddress));

            final String url = PropertiesUtils.substitute(getUrl(), propertiesMap);
            return new JMXServiceURL(url);
        }
    }

