    /**
     * Verify that the connector is closed when an exception is throws on connect.
     *
     * @throws IOException test
     */
    @Test
    public void canCloseConnectorOnConnectException() throws IOException {
        // Mock the connector and register it with our client provider
        JMXConnector connector = mock(JMXConnector.class);
        ClientProvider.setConnector(connector);

        // This property is set so that the connector factory can find our ClientProvider class
        System.setProperty(JMXConnectorFactory.PROTOCOL_PROVIDER_PACKAGES, "org.opennms.netmgt.jmx.connection");
        try {
            // Throw an exception on connect
            when(connector.getMBeanServerConnection()).thenThrow(new IOException("Cannot connect"));

            // Try to connect
            try {
                connect();
                fail("Connect should throw an exception.");
            } catch (JmxServerConnectionException e) {
                // pass
            }

            // Verify that the connector was closed
            verify(connector, times(1)).close();
        } finally {
            System.clearProperty(JMXConnectorFactory.PROTOCOL_PROVIDER_PACKAGES);
        }
    }

