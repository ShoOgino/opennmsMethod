    @Override
    public void beforeTestMethod(final TestContext testContext) throws Exception {
        super.beforeTestClass(testContext);

        final JUnitSnmpAgents agents = findAgentListAnnotation(testContext);
        final JUnitSnmpAgent agent = findAgentAnnotation(testContext);

        // save the existing stragegy property
        String strategy = System.getProperty(STRATEGY_CLASS_PROPERTY);
        testContext.setAttribute(STRATEGY_CLASS_KEY, strategy);

        // if no annotations exists then do nothing
        if (agents == null && agent == null) {
            // no annotations found
            return;
        }

        // determine if we should use the mock strategry
        boolean useMockSnmpStrategy = shouldUseMockStrategy(agents, agent);
        
        // override the configured strategy to use the mock strategy if necessary
        if (useMockSnmpStrategy) {
            strategy = MockSnmpStrategy.class.getName();
            System.setProperty(STRATEGY_CLASS_PROPERTY, MockSnmpStrategy.class.getName());
            LogUtils.infof(this, "Forcing JUnit SNMP Agent to use mock strategy");
        }

        LogUtils.debugf(this, "Initializing JUnit SNMP Agent with strategy: %s", strategy == null ? "default" : strategy);

        final HashMap<SnmpAgentAddress,MockSnmpAgent> mockAgents = new HashMap<SnmpAgentAddress,MockSnmpAgent>();
        testContext.setAttribute(AGENT_KEY, mockAgents);

        
        
        final MockSnmpDataProvider provider = useMockSnmpStrategy 
                ? new MockSnmpStrategyDataProvider() 
                : new MockSnmpAgentDataProvider(mockAgents);
                
        testContext.setAttribute(PROVIDER_KEY, provider);

        if (agents != null) {
            for (final JUnitSnmpAgent a : agents.value()) {
                handleSnmpAgent(testContext, a, useMockSnmpStrategy, provider);
            }
        }

        handleSnmpAgent(testContext, agent, useMockSnmpStrategy, provider);

        if (testContext.getTestInstance() instanceof MockSnmpDataProviderAware) {
        	LogUtils.debugf(this, "injecting data provider into MockSnmpDataProviderAware test: %s", testContext.getTestInstance());
            ((MockSnmpDataProviderAware)testContext.getTestInstance()).setMockSnmpDataProvider(provider);
        }
    }

