    public void handleTCPRequest(final Socket s) throws SocketTimeoutException {
        try {
            final InputStream is = s.getInputStream();
            final DataInputStream dataIn = new DataInputStream(is);
            int inLength = dataIn.readUnsignedShort();
            byte[] in = new byte[inLength];
            dataIn.readFully(in);

            Message query;
            byte[] response = null;
            try {
                query = new Message(in);
                response = generateReply(query, in, in.length, s);
                if (response == null)
                    return;
            } catch (final IOException e) {
                response = formerrMessage(in);
            }
            final DataOutputStream dataOut = new DataOutputStream(s.getOutputStream());
            dataOut.writeShort(response.length);
            dataOut.write(response);
        } catch (final SocketTimeoutException e) {
            throw e;
        } catch (final IOException e) {
            LogUtils.warnf(this, e, "error while processing socket");
        } finally {
            try {
                s.close();
            } catch (final IOException e) {
                LogUtils.warnf(this, e, "unable to close TCP socket");
            }
        }
    }

