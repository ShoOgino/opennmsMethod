    private void createTestDatabase() throws TemporaryDatabaseException {
        Connection adminConnection;
        try {
            adminConnection = getAdminDataSource().getConnection();
        } catch (final SQLException e) {
            throw new TemporaryDatabaseException("Failed to get admin connection: " + e.getMessage(), e);
        }
        Statement st = null;
        String dbSource = null;
        try {
            st = adminConnection.createStatement();
            String create;
            if (m_populateSchema) {
                dbSource = getIntegrationTestDatabaseName();
                create = "CREATE DATABASE " + getTestDatabase() + " WITH TEMPLATE " + dbSource + " OWNER opennms";
            } else {
                dbSource = "template1";
                create = "CREATE DATABASE " + getTestDatabase() + " WITH ENCODING='UNICODE'";
            }
            st.execute(create);

            if (m_plpgsqlIplike) {
                final Migrator m1 = new Migrator();
                m1.setDataSource(m_dataSource);
                m1.setAdminDataSource(m_adminDataSource);
                m1.setValidateDatabaseVersion(true);
                m1.setCreateUser(false);
                m1.setCreateDatabase(true);
                final Migrator m = m1;
                m.dropExistingIpLike();
                m.createLangPlPgsql();
            }
        } catch (final Throwable e) {
            try {
                st = adminConnection.createStatement();
                String query = "SELECT pid,usename,query,usename FROM pg_stat_activity where datname = '" + dbSource + "'";
                ResultSet rs = st.executeQuery(query);
                System.err.println("*** database activity immediately after exception '" + e + "' ***");
                System.err.println("*** query: '" + query + "' ***");
                while (rs.next()) {
                    System.err.println("pg_stat_activity: " + rs.getInt(1) + ", " + rs.getString(2) + ", " + rs.getString(3) + ", " + rs.getString(4));
                }
                System.err.println("*** end database activity ***");
            } catch (SQLException sqlE) {
                System.err.println("Got an exception while trying to run pg_stat_activity query after a previous exception: " + sqlE);
                sqlE.printStackTrace();
            }
            throw new TemporaryDatabaseException("Failed to create Unicode test database " + getTestDatabase() + ": " + e, e);
        } finally {
            SQLException failed = null;
            if (st != null) {
                try {
                    st.close();
                } catch (final SQLException e) {
                    failed = e;
                }
            }
            try {
                adminConnection.close();
            } catch (final SQLException e) {
                if (failed == null) failed = e;
            }
            if (failed != null) {
                throw new TemporaryDatabaseException("Failed while cleaning up database resources: " + failed, failed);
            }
        }

        registerDestruction();
    }

