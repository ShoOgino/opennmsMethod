    protected static MockHttpServletRequest createRequest(final ServletContext context, final String requestType, final String urlPath, Map<String, String> parameterMap, final String username, final Collection<String> roles) {
        final MockHttpServletRequest request = new MockHttpServletRequestThatWorks(context, requestType, contextPath + urlPath);
        request.setContextPath(contextPath);
        request.setUserPrincipal(MockUserPrincipal.getInstance());
        MockUserPrincipal.setName(username);
        if (username != null) {
            for (final String role : roles) {
                request.addUserRole(role);
            }
        }
        if (parameterMap != null) {
            for (Entry<String, String> eachEntry : parameterMap.entrySet()) {
                request.addParameter(eachEntry.getKey(), eachEntry.getValue());
            }
        }
        return request;
    }

