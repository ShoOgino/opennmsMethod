    /**
     * Sends and SNMP4J request pdu.  The attributes in SnmpAgentConfig should have been
     * adapted from default SnmpAgentConfig values to those compatible with the SNMP4J library.
     * 
     * @param agentConfig
     * @param pduType TODO
     * @param oids
     * @return
     */
    protected SnmpValue[] send(Snmp4JAgentConfig agentConfig, int pduType, SnmpObjId[] oids) {
        
        SnmpValue[] values = { null };
        Snmp session = null;
        
        try {
            session = SnmpHelpers.createSnmpSession(agentConfig);
            session = new Snmp(new DefaultUdpTransportMapping());
            session.listen();
            
            session.getUSM().addUser((agentConfig.getSecurityName()),
                    new UsmUser(agentConfig.getSecurityName(),
                            agentConfig.getAuthProtocol(),
                            agentConfig.getAuthPassPhrase(),
                            agentConfig.getPrivProtocol(),
                            agentConfig.getPrivPassPhrase()));
            
            Target target = agentConfig.getTarget();
            PDU pdu = SnmpHelpers.createPDU(agentConfig.getVersion());
            pdu.setType(pduType);
            
            //TODO:log this
            if (!buildPdu(pdu, oids))
                return null;
            
            ResponseEvent responseEvent = session.send(pdu, target);
            
            if (responseEvent.getResponse() == null) {
                log().warn("send: Timeout.  Agent: "+agentConfig);
            } else if (responseEvent.getResponse().get(0).getSyntax() == SMIConstants.SYNTAX_NULL) {
                values[0] = null;
            } else if (responseEvent.getError() != null) {
                log().warn("send: Error during get operation.  Error: "+responseEvent.getError().getLocalizedMessage());
            } else if (responseEvent.getResponse().getType() == PDU.REPORT) {
                log().warn("send: Error during get operation.  Report returned with varbinds: "+responseEvent.getResponse().getVariableBindings());
            } else if (responseEvent.getResponse().getVariableBindings().size() < 1) {
                log().warn("send: Received PDU with 0 varbinds.");
            } else {
                
                values = new Snmp4JValue[responseEvent.getResponse().getVariableBindings().size()];
                
                for (int i=0; i<values.length; i++) {
                    values[i] = new Snmp4JValue(responseEvent.getResponse().get(i).getVariable());
                }
                
                if (log().isDebugEnabled())
                    log().debug("send: Snmp operation successful. Value: "+values);
            }
            
        } catch (IOException e) {
            log().error("getNext: Could not create Snmp session for Agent: "+agentConfig+". "+e);
        } finally {
            try {
                if (session != null) {
                    session.close();
                }
            } catch (IOException e) {
                log().error("send: Error closinging SNMP connection: "+e);
            }
        }
        return values;
        
    }

