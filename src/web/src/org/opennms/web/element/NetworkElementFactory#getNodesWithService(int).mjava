    /**
     * Returns all non-deleted nodes that have the given service.
     */
    public static Node[] getNodesWithService( int serviceId ) throws SQLException {
        Node[] nodes = null;
        Connection conn = Vault.getDbConnection();

        try {
            PreparedStatement stmt = conn.prepareStatement( "SELECT * FROM NODE WHERE NODEID IN (SELECT NODEID FROM IFSERVICES WHERE SERVICEID=?) AND NODETYPE != 'D' ORDER BY NODELABEL" );
            stmt.setInt( 1, serviceId );
            ResultSet rs = stmt.executeQuery();
    
            nodes = rs2Nodes( rs );
            
            rs.close();
            stmt.close();
        }
        finally {
            Vault.releaseDbConnection( conn );
        }

        return nodes;
    }

