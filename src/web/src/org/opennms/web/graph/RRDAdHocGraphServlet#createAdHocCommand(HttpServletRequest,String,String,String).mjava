    protected String createAdHocCommand(HttpServletRequest request, String rrdDir, String start, String end) {
        String title = this.properties.getProperty("adhoc.command.title");
        String ds = this.properties.getProperty("adhoc.command.ds");
        String graphline = this.properties.getProperty("adhoc.command.graphline");

        // remember rrdtool wants the time in seconds, not milliseconds;
        // java.util.Date.getTime() returns milliseconds, so divide by 1000
        String starttime = Long.toString(Long.parseLong(start) / 1000);
        String endtime = Long.toString(Long.parseLong(end) / 1000);

        String graphtitle = request.getParameter("title");

        if (graphtitle == null) {
            return null;
        }

        StringBuffer buf = new StringBuffer();
        buf.append(this.commandPrefix);
        buf.append(" ");
        buf.append(title);

        String dsNames[] = request.getParameterValues("ds");
        String dsAggregFxns[] = request.getParameterValues("agfunction");
        String colors[] = request.getParameterValues("color");
        String dsTitles[] = request.getParameterValues("dstitle");
        String dsStyles[] = request.getParameterValues("style");

        if (dsNames == null || dsAggregFxns == null || colors == null || dsTitles == null || dsStyles == null) {
            return null;
        }

        for (int i = 0; i < dsNames.length; i++) {
            String dsAbbrev = "ds" + Integer.toString(i);

            String dsName = dsNames[i];
            String rrd = this.workDir + File.separator + rrdDir + File.separator + dsNames[i] + RrdFileConstants.RRD_SUFFIX;
            String dsAggregFxn = dsAggregFxns[i];
            String color = colors[i];
            String dsTitle = dsTitles[i];
            String dsStyle = dsStyles[i];

            buf.append(" ");
            buf.append(MessageFormat.format(ds, new String[] { rrd, starttime, endtime, graphtitle, dsAbbrev, dsName, dsAggregFxn, dsStyle, color, dsTitle }));
        }

        for (int i = 0; i < dsNames.length; i++) {
            String dsAbbrev = "ds" + Integer.toString(i);

            String dsName = dsNames[i];
            String rrd = rrdDir + File.separator + dsNames[i] + RrdFileConstants.RRD_SUFFIX;
            String dsAggregFxn = dsAggregFxns[i];
            String color = colors[i];
            String dsTitle = dsTitles[i];
            String dsStyle = dsStyles[i];

            buf.append(" ");
            buf.append(MessageFormat.format(graphline, new String[] { rrd, starttime, endtime, graphtitle, dsAbbrev, dsName, dsAggregFxn, dsStyle, color, dsTitle }));
        }

        return MessageFormat.format(buf.toString(), new String[] { "bogus-rrd", starttime, endtime, graphtitle });
    }

