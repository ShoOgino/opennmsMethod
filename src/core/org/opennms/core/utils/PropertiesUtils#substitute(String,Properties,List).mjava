    private static String substitute(String initialString, Properties properties, List list) {
        if (initialString == null) return null;
        
        StringBuffer result = new StringBuffer(initialString);
        
        int startIndex = 0;
        
        while (startIndex >= 0) {
            int beginIndex = result.indexOf("${", startIndex);
            int endIndex = (beginIndex < 0 ? -1 : result.indexOf("}", beginIndex+"${".length()));
            if (endIndex >= 0) {
                String propName = result.substring(beginIndex+"${".length(), endIndex);
                if (list.contains(propName))
                    throw new IllegalStateException("recursive loop involving property ${"+propName+"}");
                String propValue = properties.getProperty(propName);
                if (propValue != null) {
                    list.add(propName);
                    String substVal = substitute(propValue, properties, list);
                    list.remove(list.size()-1);
                    result.replace(beginIndex, endIndex+1, substVal);
                    startIndex = beginIndex + substVal.length();
                    
                } else {
                    startIndex = endIndex+1;
                }
            } else {
                startIndex = -1;
            }
        }
        return result.toString();
    }

