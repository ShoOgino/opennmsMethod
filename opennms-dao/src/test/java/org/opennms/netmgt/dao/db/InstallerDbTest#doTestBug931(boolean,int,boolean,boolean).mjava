    public void doTestBug931(boolean dropForeignTable, int badRows,
            boolean fixConstraint, boolean removeRows) throws Exception {
        final String errorSubstring;
        if (dropForeignTable) {
            errorSubstring = "Table events contains "
                + badRows
                + " rows (out of 2) that violate new constraint "
                + s_constraint
                + ".  See the install guide for details on how to correct this "
                + "problem.  You can execute this SQL query to see a list of "
                + "the rows that violate the constraint:\n"
                + "SELECT * FROM events WHERE events.nodeid IS NOT NULL";
        } else {
            errorSubstring = "Table events contains "
                + badRows
                + " rows (out of 2) that violate new constraint "
                + s_constraint
                + ".  See the install guide for details on how to correct this "
                + "problem.  You can execute this SQL query to see a list of "
                + "the rows that violate the constraint:\n"
                + "SELECT * FROM events LEFT JOIN node ON (events.nodeid = "
                + "node.nodeid) WHERE node.nodeid is NULL AND events.nodeid "
                + "IS NOT NULL";
        }

        setupBug931((badRows != 0) || fixConstraint, dropForeignTable);

        if (fixConstraint) {
            getInstallerDb().fixConstraint(s_constraint, removeRows);
        }

        ThrowableAnticipator ta = new ThrowableAnticipator();
        if (badRows > 0) {
            ta.anticipate(new Exception(errorSubstring));
        }

        try {
            getInstallerDb().checkConstraints();
        } catch (Throwable t) {
            ta.throwableReceived(t);
        }

        ta.verifyAnticipated();
    }

