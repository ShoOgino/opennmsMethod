    /** Test for bug 1594 */
    public void testQueryWithHierarchyCloseTransaction() throws Exception {
        /*
         * Close the current transaction and start a new one so that we get
         * fresh data from the DB.
         */
        setComplete();
        endTransaction();
        
        startNewTransaction();
        
        OnmsNode n = getNodeDao().getHierarchy(1);
        
        /*
         * Close the current transaction and session -- the data should have
         * all been fetched from the DB already
         */
        endTransaction();
        
        validateNode(n);

        for (OnmsIpInterface ip : n.getIpInterfaces()) {
            ip.getIpAddress();
            for (OnmsMonitoredService service : ip.getMonitoredServices()) {
                service.getServiceName();
            }
        }

        // Test for bug 1594
        for (OnmsSnmpInterface snmp : n.getSnmpInterfaces()) {
            for (OnmsIpInterface ip : snmp.getIpInterfaces()) {
                ip.getIpAddress();
            }
        }
    }

