    /** {@inheritDoc} */
    public Map<String, Set<String>> getIPServiceMap(String rule) throws FilterParseException {
        Map<String, Set<String>> ipServices = new TreeMap<String, Set<String>>();
        String sqlString;

        if (log().isDebugEnabled()) {
            log().debug("Filter: rule: " + rule);
        }

        // get the database connection
        Connection conn = null;
        DBUtils d = new DBUtils(getClass());
        try {
            conn = getDataSource().getConnection();
            d.watch(conn);

            // parse the rule and get the sql select statement
            sqlString = getIPServiceMappingStatement(rule);
            if (log().isDebugEnabled()) {
                log().debug("Filter: SQL statement: " + sqlString);
            }

            // execute query
            Statement stmt = conn.createStatement();
            d.watch(stmt);
            ResultSet rset = stmt.executeQuery(sqlString);
            d.watch(rset);

            // fill up the array list if the result set has values
            if (rset != null) {
                // Iterate through the result and build the array list
                while (rset.next()) {
                    String ipaddr = rset.getString(1);

                    if (!ipServices.containsKey(ipaddr)) {
                        ipServices.put(ipaddr, new TreeSet<String>());
                    }

                    ipServices.get(ipaddr).add(rset.getString(2));
                }
            }

        } catch (FilterParseException e) {
            log().info("Filter Parse Exception occurred getting IP Service List: " + e, e);
            throw new FilterParseException("Filter Parse Exception occurred getting IP Service List: " + e);
        } catch (SQLException e) {
            log().info("SQL Exception occurred getting IP Service List: " + e, e);
            throw new FilterParseException("SQL Exception occurred getting IP Service List: " + e);
        } catch (Exception e) {
            log().fatal("Exception getting database connection: " + e, e);
            throw new UndeclaredThrowableException(e);
        } finally {
            d.cleanUp();
        }

        return ipServices;
    }

