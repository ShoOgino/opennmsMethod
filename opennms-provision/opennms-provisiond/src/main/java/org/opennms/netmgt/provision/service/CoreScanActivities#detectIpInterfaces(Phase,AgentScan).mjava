    @Activity( lifecycle = "agentScan", phase = "detectIpInterfaces" )
    public void detectIpInterfaces(final Phase currentPhase, final AgentScan agentScan) throws InterruptedException {
        SnmpAgentConfig agentConfig = m_agentConfigFactory.getAgentConfig(agentScan.getAgentAddress());
        Assert.notNull(m_agentConfigFactory, "agentConfigFactory was not injected");

        // mark all provisioned interfaces as 'in need of scanning' so we can mark them
        // as scanned during ipAddrTable processing
        final Set<String> provisionedIps = new HashSet<String>();
        for(OnmsIpInterface provisioned : agentScan.getNode().getIpInterfaces()) {
            provisionedIps.add(provisioned.getIpAddress());
        }
        
        
        final IPInterfaceTableTracker ipIfTracker = new IPInterfaceTableTracker() {
            @Override
            public void processIPInterfaceRow(IPInterfaceRow row) {
                System.out.println("Processing row with ipAddr "+row.getIpAddress());
                if (!row.getIpAddress().startsWith("127.0.0")) {
                    
                    // mark any provisioned interface as scanned
                    provisionedIps.remove(row.getIpAddress());
                    
                    // save the interface
                    OnmsIpInterface iface = row.createInterfaceFromRow();
                    iface.setIpLastCapsdPoll(agentScan.getScanStamp());
                    
                    // add call to the ip interface is managed policies
                    iface.setIsManaged("M");
                    
                    List<IpInterfacePolicy> policies = m_provisionService.getIpInterfacePoliciesForForeignSource(agentScan.getForeignSource());
                    
                    for(IpInterfacePolicy policy : policies) {
                        if (iface != null) {
                            iface = policy.apply(iface);
                        }
                    }
                    
                    if (iface != null) {
                        currentPhase.add(ipUpdater(currentPhase, agentScan, iface), "write");
                    }
                    
                }
            }
        };
        
        SnmpWalker walker = SnmpUtils.createWalker(agentConfig, "ipAddrTable", ipIfTracker);
        walker.start();
        walker.waitFor();
        
        // After processing the snmp provided interfaces then we need to scan any that 
        // were provisioned but missing from the ip table
        for(String ipAddr : provisionedIps) {
            OnmsIpInterface iface = agentScan.getNode().getIpInterfaceByIpAddress(ipAddr);
            iface.setIpLastCapsdPoll(agentScan.getScanStamp());
            iface.setIsManaged("M");
            
            currentPhase.add(ipUpdater(currentPhase, agentScan, iface), "write");
            
        }
        
        
        System.err.println("detectIpInterfaces");
    }

