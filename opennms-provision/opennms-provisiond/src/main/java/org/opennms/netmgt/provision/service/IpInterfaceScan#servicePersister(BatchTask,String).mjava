    /**
     * <p>servicePersister</p>
     *
     * @param currentPhase a {@link org.opennms.core.tasks.BatchTask} object.
     * @param serviceName a {@link java.lang.String} object.
     * @return a {@link org.opennms.core.tasks.Callback} object.
     */
    public Callback<Boolean> servicePersister(final BatchTask currentPhase, final String serviceName) {
        return new Callback<Boolean>() {
            public void complete(Boolean serviceDetected) {
                infof(this, "Attempted to detect service %s on address %s: %s", serviceName, getAddress().getHostAddress(), serviceDetected);
                if (serviceDetected) {

                    currentPhase.getBuilder().addSequence(
                            new RunInBatch() {

                                public void run(BatchTask batch) {

                                    if ("SNMP".equals(serviceName)) {
                                        setupAgentInfo(currentPhase);
                                    }

                                }
                            }, 
                            new RunInBatch() {

                                public void run(BatchTask batch) {
                                    getProvisionService().addMonitoredService(getNodeId(), getAddress().getHostAddress(), serviceName);
                                }
                            });


                    

                }
            }

            public void handleException(Throwable t) {
                infof(this, t, "Exception occurred while trying to detect service %s on address %s", serviceName, getAddress().getHostAddress());
            }
        };
    }

