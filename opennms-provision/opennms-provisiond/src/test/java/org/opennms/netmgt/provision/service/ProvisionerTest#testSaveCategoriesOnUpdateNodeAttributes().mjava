    @Test(timeout=300000)
    @JUnitTemporaryDatabase // Relies on records created in @Before so we need a fresh database
    @Transactional
    public void testSaveCategoriesOnUpdateNodeAttributes() throws Exception {
        final String TEST_CATEGORY = "TEST_CATEGORY";
        final String LABEL = "apknd";
        
        importFromResource("classpath:/tec_dump.xml.smalltest");
        
        final Collection<OnmsNode> nodes = m_nodeDao.findByLabel(LABEL);
        assertNotNull(nodes);
        assertEquals(1, nodes.size());
        
        OnmsNode node = nodes.iterator().next();
        assertNotNull(node);
        assertEquals(LABEL, node.getLabel());
        assertFalse(node.hasCategory(TEST_CATEGORY));

        final NodeCategorySettingPolicy policy = new NodeCategorySettingPolicy();
        policy.setCategory(TEST_CATEGORY);
        policy.setLabel(LABEL);
        
        node = policy.apply(node);
        
        assertTrue(node.hasCategory(TEST_CATEGORY));
        
        m_provisionService.updateNodeAttributes(node);
        
        // flush here to force a write so we are sure that the OnmsCategories are correctly created
        m_nodeDao.flush();

        final OnmsNode node2 = m_nodeDao.findByLabel(LABEL).iterator().next();
        assertTrue(node2.hasCategory(TEST_CATEGORY));
        

    }

