    /** 
     * @throws IOException 
     */
    @Override
    protected JmxServerConnectionWrapper connect(final InetAddress address, final int port, final int timeout, final Map<String, String> runtimeAttributes) throws MalformedURLException, IOException {

        Map<String, String> props = Maps.newHashMap();
        props.put("port", String.valueOf(port));
        props.put("timeout", String.valueOf(timeout));
        props.put("factory", getFactory());
        props.put("friendlyname", getFriendlyName());
        props.put("username", getUsername());
        props.put("password", getPassword());
        props.put("urlPath", getUrlPath());
        props.put("type", getType());
        props.put("protocol", getProtocol());
        // The runtime attributes contain the agent details pull from the JmxConfigDao
        props.putAll(runtimeAttributes);

        // TODO: Refactor this to use the same code as 
        // {@link org.opennms.netmgt.jmx.impl.connection.connectors.DefaultJmxConnector}

        // If remote JMX access is enabled, this will return a non-null value
        String jmxPort = System.getProperty(JmxServerConnector.JMX_PORT_SYSTEM_PROPERTY);

        if (
            address != null && 
            // If we're trying to create a connection to a localhost address...
            address.isLoopbackAddress() &&
            (
                // If the port matches the port of the current JVM...
                String.valueOf(port).equals(jmxPort) ||
                // Or if remote JMX RMI is disabled and we're attempting to connect
                // to the default OpenNMS JMX port...
                (jmxPort == null && JmxServerConnector.DEFAULT_OPENNMS_JMX_PORT.equals(String.valueOf(port)))
            )
        ) {
            // ...then use the {@link PlatformMBeanServerConnector} to connect to 
            // this JVM's MBeanServer directly.
            try {
                return new PlatformMBeanServerConnector().createConnection(address, props);
            } catch (JmxServerConnectionException e) {
                throw new ConnectException(e.getMessage());
            }
        }

        return Jsr160ConnectionFactory.getMBeanServerConnection(props, address);
    }

