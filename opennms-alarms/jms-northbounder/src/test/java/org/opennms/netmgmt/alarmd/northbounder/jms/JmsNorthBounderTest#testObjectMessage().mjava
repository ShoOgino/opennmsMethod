    @Test
    public void testObjectMessage() throws Exception {
        String xml = objectMessageConfigXml();

        Resource resource = new ByteArrayResource(xml.getBytes());

        JmsNorthbounderConfigDao dao = new JmsNorthbounderConfigDao();
        dao.setConfigResource(resource);
        dao.afterPropertiesSet();

        JmsNorthbounderConfig config = dao.getConfig();

        List<JmsDestination> destinations = config.getDestinations();

        List<JmsNorthbounder> nbis = new LinkedList<JmsNorthbounder>();

        for (JmsDestination jmsDestination : destinations) {
            JmsNorthbounder nbi = new JmsNorthbounder(
                                                      config,
                                                      m_jmsNorthbounderConnectionFactory,
                                                      jmsDestination);
            //nbi.setNodeDao(m_nodeDao);
            nbi.afterPropertiesSet();
            nbis.add(nbi);
        }

        List<NorthboundAlarm> alarms = new LinkedList<NorthboundAlarm>();
        OnmsNode node = new OnmsNode(null, NODE_LABEL);
        node.setForeignSource("TestGroup");
        node.setForeignId("2");
        node.setId(m_nodeDao.getNextNodeId());
        OnmsIpInterface ip = new OnmsIpInterface("127.0.0.1", node);
        InetAddress ia = null;
        try {
            ia = InetAddress.getByName("127.0.0.1");
        } catch (UnknownHostException e){ }
        m_nodeDao.save(node);
        m_nodeDao.flush();
        // TX via NBIs
        for (JmsNorthbounder nbi : nbis) {
            OnmsEvent event = new OnmsEvent();
            event.setId(5);
            event.setEventUei("uei.uei.org/uei");
            event.setEventTime(new Date());
            event.setEventHost("eventhost");
            event.setEventSource("eventsource");
            event.setIpAddr(ia);
            event.setDistPoller(null);
            event.setEventSnmpHost("eventsnmphost");
            event.setServiceType(null);
            event.setEventSnmp("eventsnmp");
            event.setEventParameters(Lists.newArrayList(
                    new OnmsEventParameter(event, "syslogmessage", "Dec 22 2015 20:12:57.1 UTC :  %UC_CTI-3-CtiProviderOpenFailure: %[CTIconnectionId%61232238][ Login User Id%61pguser][Reason code.%61-1932787616][UNKNOWN_PARAMNAME:IPAddress%61172.17.12.73][UNKNOWN_PARAMNAME:IPv6Address%61][App ID%61Cisco CTIManager][Cluster ID%61SplkCluster][Node ID%61splkcucm6p]: CTI application failed to open provider%59 application startup failed", "string"),
                    new OnmsEventParameter(event, "severity", "Error", "string"),
                    new OnmsEventParameter(event, "timestamp", "Dec 22 14:13:21", "string"),
                    new OnmsEventParameter(event, "process", "229250", "string"),
                    new OnmsEventParameter(event, "service", "local7", "string")));
            event.setEventCreateTime(new Date());
            event.setEventDescr("eventdescr");
            event.setEventLogGroup("eventloggroup");
            event.setEventLogMsg("eventlogmsg");
            event.setEventSeverity(4);
            event.setEventPathOutage(null);
            event.setEventCorrelation(null);
            event.setEventSuppressedCount(0);
            event.setEventOperInstruct("operinstruct");
            event.setEventAutoAction(null);
            event.setEventOperAction(null);
            event.setEventOperActionMenuText(null);
            event.setEventNotification(null);
            event.setEventTTicket("tticketid");
            event.setEventTTicketState(1);
            event.setEventForward(null);
            event.setEventMouseOverText(null);
            event.setEventLog(null);
            event.setEventDisplay(null);
            event.setEventAckUser(null);
            event.setEventAckTime(null);
            event.setAlarm(null);
            event.setNode(node);
            event.setNotifications(null);
            event.setAssociatedServiceRegainedOutages(null);
            event.setAssociatedServiceLostOutages(null);

            OnmsAlarm alarm = new OnmsAlarm(9, event.getEventUei(), null, 1, 4, new Date(), event);
            alarm.setNode(node);
            alarm.setDescription(event.getEventDescr());
            alarm.setApplicationDN("applicationDN");
            alarm.setLogMsg(event.getEventLogMsg());
            alarm.setManagedObjectInstance("managedObjectInstance");
            alarm.setManagedObjectType("managedObjectType");
            alarm.setOssPrimaryKey("ossPrimaryKey");
            alarm.setQosAlarmState("qosAlarmState");
            alarm.setTTicketId("tticketId");
            alarm.setReductionKey("reductionKey");
            alarm.setClearKey("clearKey");
            alarm.setOperInstruct("operInstruct");
            alarm.setFirstEventTime(new Date(0));
            alarm.setAlarmType(OnmsAlarm.PROBLEM_TYPE);
            alarm.setIpAddr(ia);
            alarm.setLastEvent(event);
            alarm.setX733AlarmType(NorthboundAlarm.x733AlarmType.get(1).name());
            alarm.setX733ProbableCause(NorthboundAlarm.x733ProbableCause.get(1).getId());
            NorthboundAlarm a = new NorthboundAlarm(alarm);
            alarms.add(a);
            nbi.forwardAlarms(alarms);
        }

        Thread.sleep(100);

        // Let's become a consumer and receive the message
        Message m = m_template.receive("ObjectTestQueue");
        Assert.assertNotNull(m);
        Object response = ((ObjectMessage)m).getObject();
        Assert.assertNotNull(response);
        Assert.assertTrue("message\n'" + response + "'\n not a NorthboundAlarm\n'" + "'.", (response instanceof NorthboundAlarm));
        String rk = ((NorthboundAlarm) response).getAlarmKey();
        Assert.assertEquals("received alarm has incorrect reduction key: " + rk, "reductionKey", rk);
    }

