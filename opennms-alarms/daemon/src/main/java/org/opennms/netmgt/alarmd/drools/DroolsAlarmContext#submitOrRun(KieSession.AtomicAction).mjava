    private void submitOrRun(KieSession.AtomicAction atomicAction) {
        KieSession.AtomicAction actionWithTimeUpdate = kieSession -> {
            // Always advance the clock
            if (!isUsePseudoClock()) {
                getClock().advanceTimeToNow();
            }
            atomicAction.execute(kieSession);
        };

        if (fireThreadId.get() == Thread.currentThread().getId()) {
            // This is the fire thread! Let's execute the action immediately instead of deferring it.
            actionWithTimeUpdate.execute(getKieSession());
        } else {
            // Submit the action for execution
            // Track the number of atomic actions waiting to be executed
            final long numActionsInFlight = atomicActionsInFlight.incrementAndGet();
            if (numActionsInFlight > MAX_NUM_ACTIONS_IN_FLIGHT) {
                RATE_LIMITED_LOGGER.error("Dropping action - number of actions in flight exceed {}! " +
                        "Alarms in Drools context will not match those in the database until the next successful sync.", MAX_NUM_ACTIONS_IN_FLIGHT);
                atomicActionsDropped.mark();
                atomicActionsInFlight.decrementAndGet();
                return;
            }
            getKieSession().submit(kieSession -> {
                actionWithTimeUpdate.execute(kieSession);
                atomicActionsInFlight.decrementAndGet();
            });
            atomicActionsQueued.mark();
        }
    }

