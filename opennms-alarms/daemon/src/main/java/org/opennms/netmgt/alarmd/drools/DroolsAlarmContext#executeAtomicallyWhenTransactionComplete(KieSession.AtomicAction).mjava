    /**
     * When running in the context of a transaction, execute the given action
     * when the transaction is complete and has been successfully committed.
     *
     * If the transaction does not complete successfully, log a warning and drop the action.
     *
     * If we're not currently in a transaction, execute the action immediately.
     *
     * @param atomicAction action to consider
     */
    private void executeAtomicallyWhenTransactionComplete(KieSession.AtomicAction atomicAction) {
        if (TransactionSynchronizationManager.isSynchronizationActive()) {
            TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronizationAdapter() {
                @Override
                public void afterCompletion(int status) {
                    if (status != TransactionSynchronization.STATUS_COMMITTED) {
                        RATE_LIMITED_LOGGER.warn("A database transaction did not complete successfully. " +
                                "The alarms facts in the session may be out of sync until the next snapshot.");
                        return;
                    }
                    submitOrRun(atomicAction);
                }
            });
        } else {
            submitOrRun(atomicAction);
        }
    }

