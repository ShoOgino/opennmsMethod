    @Before
    public void setUp() {
        // Async.
        m_eventMgr.setSynchronous(false);

        // Events need database IDs to make alarmd happy
        m_eventMgr.setEventWriter(m_database);

        // Events need to real nodes too
        OnmsNode node = new OnmsNode(m_locationDao.getDefaultLocation(), "node1");
        node.setId(1);
        m_nodeDao.save(node);

        node = new OnmsNode(m_locationDao.getDefaultLocation(), "node2");
        node.setId(2);
        m_nodeDao.save(node);

        // Use a pseudo-clock
        m_droolsAlarmContext.setUsePseudoClock(true);
        // Drive the ticks ourselves
        m_droolsAlarmContext.setUseManualTick(true);

        // Set the behavior        
        if (scenario.getLegacyAlarmBehavior()) {
            m_alarmPersister.setLegacyAlarmState(true);
        }
        
        // Start alarmd
        m_alarmd.start();
    }

